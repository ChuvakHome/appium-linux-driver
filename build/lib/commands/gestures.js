"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _support = require("@appium/support");

var _baseDriver = require("@appium/base-driver");

var _xpath = _interopRequireDefault(require("xpath.js"));

var _xmldom = require("xmldom");

var _privateapis = _interopRequireDefault(require("@stdspa/stdspalinux_temp/dist/privateapis"));

var _utils = require("../utils");

const commands = {};

commands._findElRect = function (uuid) {
  const strEl = this._cache.get(uuid);

  if (!strEl) {
    throw new _baseDriver.errors.NoSuchElementError("the element doesn't exist");
  }

  const doc = new _xmldom.DOMParser().parseFromString(strEl);

  if (!doc.documentElement.attributes) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element has no rect attribute");
  }

  let attrs = Array.from(doc.documentElement.attributes);
  attrs = attrs.reduce((prev, curr) => {
    prev[curr.name] = curr.value;
    return prev;
  }, {});
  const rect = attrs.rect;

  if (!rect) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element has no rect attribute");
  }

  const mat = /^\[(?<x>\d+)\,(?<y>\d+)\,(?<width>\d+)\,(?<height>\d+)\]$/.exec(rect);

  if (!mat) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element's rect attribute is malformed");
  }

  const {
    x,
    y,
    width,
    height
  } = mat.groups;
  return {
    x: Number.parseInt(x),
    y: Number.parseInt(y),
    width: Number.parseInt(width),
    height: Number.parseInt(height)
  };
};

commands.setValue = commands.replaceValue = commands.setValueImmediate = async function setValue(values, elementId) {
  const uuid = elementId;
  const _v = values[0];

  const {
    x,
    y,
    width,
    height
  } = this._findElRect(uuid);

  const _x = x + width / 2;

  const _y = y + height / 2;

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.mouse_click(_x, _y, 1);

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.keyboard_tapKey('a', 4);

  await (0, _utils.wait4sec)(0.1);

  _privateapis.default.keyboard_tapKeyCode(65535, 0);

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.keyboard_typeStringCopyPaste(_v);

  return null;
};

commands.click = async function click(elementId) {
  const uuid = elementId;

  const {
    x,
    y,
    width,
    height
  } = this._findElRect(uuid);

  const _x = x + width / 2;

  const _y = y + height / 2;

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.mouse_click(_x, _y, 1);

  return null;
};

commands.pressKeyCode = function pressKeyCode(keycode, metastate) {
  metastate || (metastate = 0);

  if (keycode >= 0) {
    _privateapis.default.keyboard_tapKeyCode(keycode, metastate);
  } else {
    _privateapis.default.keyboard_tapKey(String.fromCharCode(-keycode), metastate);
  }

  return null;
};

commands.longPressKeyCode = async function longPressKeyCode(keycode, metastate) {
  metastate || (metastate = 0);
  const isKeyCode = keycode >= 0;

  if (isKeyCode) {
    _privateapis.default.keyboard_toggleKeyCode(keycode, true, metastate);

    await (0, _utils.wait4sec)(0.5);

    _privateapis.default.keyboard_toggleKeyCode(keycode, false, metastate);
  } else {
    _privateapis.default.keyboard_toggleKey(String.fromCharCode(-keycode), true, metastate);

    await (0, _utils.wait4sec)(0.5);

    _privateapis.default.keyboard_toggleKey(String.fromCharCode(-keycode), false, metastate);
  }

  return null;
};

commands.getProperty = commands.getAttribute = function getProperty(name, elementId) {
  const strEl = this._cache.get(elementId);

  if (!strEl) {
    throw new _baseDriver.errors.NoSuchElementError("the element doesn't exist");
  }

  const doc = new _xmldom.DOMParser().parseFromString(strEl);

  if (!doc.documentElement.attributes) {
    throw new _baseDriver.errors.UnknownError("the element has no attributes");
  }

  let attrs = Array.from(doc.documentElement.attributes);
  attrs = attrs.reduce((prev, curr) => {
    prev[curr.name] = curr.value;
    return prev;
  }, {});
  return attrs[name];
};

commands.getElementRect = function getElementRect(elementId) {
  const rect = this.getProperty('rect', elementId);

  if (!rect) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element has no rect attribute");
  }

  const mat = /^\[(?<x>\d+)\,(?<y>\d+)\,(?<width>\d+)\,(?<height>\d+)\]$/.exec(rect);

  if (!mat) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element's rect attribute is malformed");
  }

  const {
    x,
    y,
    width,
    height
  } = mat.groups;
  return {
    x: Number.parseInt(x),
    y: Number.parseInt(y),
    width: Number.parseInt(width),
    height: Number.parseInt(height)
  };
};

commands.getSize = function getSize(elementId) {
  const rect = this.getElementRect(elementId);
  return {
    width: rect.width,
    height: rect.height
  };
};

commands.clear = async function clear(elementId) {
  await this.click(elementId);
  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.keyboard_tapKey('a', 4);

  await (0, _utils.wait4sec)(0.1);

  _privateapis.default.keyboard_tapKeyCode(65535, 0);
};

commands.getName = function getName(elementId) {
  const name = this.getProperty('name', elementId);
  return name;
};

commands.getText = function getText(elementId) {
  const text = this.getProperty('text', elementId);
  return text;
};

commands.linuxGetDisplaySize = function linuxGetDisplaySize() {
  return _privateapis.default.c_getMainDisplaySize();
};

commands.linuxMouseMove = function linuxMouseMove(opts = {}) {
  const {
    x,
    y
  } = opts;

  const _x = Number.parseInt(x);

  const _y = Number.parseInt(y);

  if (!_support.util.hasValue(_x) || !_support.util.hasValue(_y)) {
    throw new _baseDriver.errors.UnknownError("parameter x, y are required");
  }

  _privateapis.default.mouse_move(_x, _y);

  return null;
};

commands.linuxMouseSwipe = function linuxMouseSwipe(opts = {}) {
  const {
    sx,
    sy,
    ex,
    ey
  } = opts;

  const _sx = Number.parseInt(sx);

  const _sy = Number.parseInt(sy);

  const _ex = Number.parseInt(ex);

  const _ey = Number.parseInt(ey);

  if (!_support.util.hasValue(_sx) || !_support.util.hasValue(_sy) || !_support.util.hasValue(_ex) || !_support.util.hasValue(_ey)) {
    throw new _baseDriver.errors.UnknownError("parameter sx, sy, ex, ey are required");
  }

  _privateapis.default.mouse_swipe(_sx, _sy, _ex, _ey);

  return null;
};

commands.linuxRightClick = function linuxRightClick(opts = {}) {
  const {
    elementId
  } = opts;

  if (!_support.util.hasValue(elementId)) {
    throw new _baseDriver.errors.UnknownError("parameter elementId is required");
  }

  const rect = this.getElementRect(elementId);
  const x = rect.x + rect.width / 2;
  const y = rect.y + rect.height / 2;

  _privateapis.default.mouse_click(x, y, 3);

  return null;
};

commands.linuxDoubleClick = function linuxDoubleClick(opts = {}) {
  const {
    elementId
  } = opts;

  if (!_support.util.hasValue(elementId)) {
    throw new _baseDriver.errors.UnknownError("parameter elementId is required");
  }

  const rect = this.getElementRect(elementId);
  const x = rect.x + rect.width / 2;
  const y = rect.y + rect.height / 2;

  _privateapis.default.mouse_doubleClick(x, y, 1);

  return null;
};

commands.linuxMouseScroll = function linuxMouseScroll(opts = {}) {
  const {
    moveLeftSteps,
    moveUpSteps
  } = opts;

  let _moveLeftSteps = Number.parseInt(moveLeftSteps);

  let _moveUpSteps = Number.parseInt(moveUpSteps);

  _moveLeftSteps = !_moveLeftSteps ? 0 : _moveLeftSteps;
  _moveUpSteps = !_moveUpSteps ? 0 : _moveUpSteps;

  if (_moveLeftSteps != 0 || _moveUpSteps != 0) {
    _privateapis.default.mouse_scroll_x_y(_moveLeftSteps, _moveUpSteps);
  }
};

commands.linuxCopy = function linuxCopy(opts = {}) {
  const {
    str
  } = opts;

  if (!_support.util.hasValue(str)) {
    throw new _baseDriver.errors.UnknownError("parameter str is required");
  }

  _privateapis.default.keyboard_copy(str);
};

commands.linuxGetClipboard = function linuxGetClipboard() {
  return _privateapis.default.keyboard_getClipboardContent();
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZXN0dXJlcy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIl9maW5kRWxSZWN0IiwidXVpZCIsInN0ckVsIiwiX2NhY2hlIiwiZ2V0IiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiZG9jIiwiZG9tIiwicGFyc2VGcm9tU3RyaW5nIiwiZG9jdW1lbnRFbGVtZW50IiwiYXR0cmlidXRlcyIsIkludmFsaWRFbGVtZW50Q29vcmRpbmF0ZXNFcnJvciIsImF0dHJzIiwiQXJyYXkiLCJmcm9tIiwicmVkdWNlIiwicHJldiIsImN1cnIiLCJuYW1lIiwidmFsdWUiLCJyZWN0IiwibWF0IiwiZXhlYyIsIngiLCJ5Iiwid2lkdGgiLCJoZWlnaHQiLCJncm91cHMiLCJOdW1iZXIiLCJwYXJzZUludCIsInNldFZhbHVlIiwicmVwbGFjZVZhbHVlIiwic2V0VmFsdWVJbW1lZGlhdGUiLCJ2YWx1ZXMiLCJlbGVtZW50SWQiLCJfdiIsIl94IiwiX3kiLCJhcGlzIiwibW91c2VfY2xpY2siLCJrZXlib2FyZF90YXBLZXkiLCJrZXlib2FyZF90YXBLZXlDb2RlIiwia2V5Ym9hcmRfdHlwZVN0cmluZ0NvcHlQYXN0ZSIsImNsaWNrIiwicHJlc3NLZXlDb2RlIiwia2V5Y29kZSIsIm1ldGFzdGF0ZSIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsImxvbmdQcmVzc0tleUNvZGUiLCJpc0tleUNvZGUiLCJrZXlib2FyZF90b2dnbGVLZXlDb2RlIiwia2V5Ym9hcmRfdG9nZ2xlS2V5IiwiZ2V0UHJvcGVydHkiLCJnZXRBdHRyaWJ1dGUiLCJVbmtub3duRXJyb3IiLCJnZXRFbGVtZW50UmVjdCIsImdldFNpemUiLCJjbGVhciIsImdldE5hbWUiLCJnZXRUZXh0IiwidGV4dCIsImxpbnV4R2V0RGlzcGxheVNpemUiLCJjX2dldE1haW5EaXNwbGF5U2l6ZSIsImxpbnV4TW91c2VNb3ZlIiwib3B0cyIsInV0aWwiLCJoYXNWYWx1ZSIsIm1vdXNlX21vdmUiLCJsaW51eE1vdXNlU3dpcGUiLCJzeCIsInN5IiwiZXgiLCJleSIsIl9zeCIsIl9zeSIsIl9leCIsIl9leSIsIm1vdXNlX3N3aXBlIiwibGludXhSaWdodENsaWNrIiwibGludXhEb3VibGVDbGljayIsIm1vdXNlX2RvdWJsZUNsaWNrIiwibGludXhNb3VzZVNjcm9sbCIsIm1vdmVMZWZ0U3RlcHMiLCJtb3ZlVXBTdGVwcyIsIl9tb3ZlTGVmdFN0ZXBzIiwiX21vdmVVcFN0ZXBzIiwibW91c2Vfc2Nyb2xsX3hfeSIsImxpbnV4Q29weSIsInN0ciIsImtleWJvYXJkX2NvcHkiLCJsaW51eEdldENsaXBib2FyZCIsImtleWJvYXJkX2dldENsaXBib2FyZENvbnRlbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBQSxRQUFRLENBQUNDLFdBQVQsR0FBdUIsVUFBU0MsSUFBVCxFQUFlO0FBQ3BDLFFBQU1DLEtBQUssR0FBRyxLQUFLQyxNQUFMLENBQVlDLEdBQVosQ0FBZ0JILElBQWhCLENBQWQ7O0FBQ0EsTUFBSSxDQUFDQyxLQUFMLEVBQVk7QUFDVixVQUFNLElBQUlHLG1CQUFPQyxrQkFBWCxDQUE4QiwyQkFBOUIsQ0FBTjtBQUNEOztBQUNELFFBQU1DLEdBQUcsR0FBRyxJQUFJQyxpQkFBSixHQUFVQyxlQUFWLENBQTBCUCxLQUExQixDQUFaOztBQUNBLE1BQUksQ0FBQ0ssR0FBRyxDQUFDRyxlQUFKLENBQW9CQyxVQUF6QixFQUFxQztBQUNuQyxVQUFNLElBQUlOLG1CQUFPTyw4QkFBWCxDQUEwQyxtQ0FBMUMsQ0FBTjtBQUNEOztBQUNELE1BQUlDLEtBQUssR0FBR0MsS0FBSyxDQUFDQyxJQUFOLENBQVdSLEdBQUcsQ0FBQ0csZUFBSixDQUFvQkMsVUFBL0IsQ0FBWjtBQUNBRSxFQUFBQSxLQUFLLEdBQUdBLEtBQUssQ0FBQ0csTUFBTixDQUFhLENBQUNDLElBQUQsRUFBT0Ms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ZUFJZTlGLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ0BhcHBpdW0vYmFzZS1kcml2ZXInO1xuaW1wb3J0IHNlbGVjdCBmcm9tICd4cGF0aC5qcyc7XG5pbXBvcnQgeyBET01QYXJzZXIgYXMgZG9tIH0gZnJvbSAneG1sZG9tJztcbmltcG9ydCBhcGlzIGZyb20gJ0BzdGRzcGEvc3Rkc3BhbGludXhfdGVtcC9kaXN0L3ByaXZhdGVhcGlzJztcbmltcG9ydCB7IHdhaXQ0c2VjIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5fZmluZEVsUmVjdCA9IGZ1bmN0aW9uKHV1aWQpIHtcbiAgY29uc3Qgc3RyRWwgPSB0aGlzLl9jYWNoZS5nZXQodXVpZCk7XG4gIGlmICghc3RyRWwpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcihcInRoZSBlbGVtZW50IGRvZXNuJ3QgZXhpc3RcIik7XG4gIH1cbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyhzdHJFbCk7XG4gIGlmICghZG9jLmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkRWxlbWVudENvb3JkaW5hdGVzRXJyb3IoXCJ0aGUgZWxlbWVudCBoYXMgbm8gcmVjdCBhdHRyaWJ1dGVcIik7XG4gIH1cbiAgbGV0IGF0dHJzID0gQXJyYXkuZnJvbShkb2MuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMpO1xuICBhdHRycyA9IGF0dHJzLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuICAgIHByZXZbY3Vyci5uYW1lXSA9IGN1cnIudmFsdWU7XG4gICAgcmV0dXJuIHByZXY7XG4gIH0sIHt9KTtcbiAgY29uc3QgcmVjdCA9IGF0dHJzLnJlY3Q7XG4gIGlmICghcmVjdCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEVsZW1lbnRDb29yZGluYXRlc0Vycm9yKFwidGhlIGVsZW1lbnQgaGFzIG5vIHJlY3QgYXR0cmlidXRlXCIpO1xuICB9XG4gIGNvbnN0IG1hdCA9IC9eXFxbKD88eD5cXGQrKVxcLCg/PHk+XFxkKylcXCwoPzx3aWR0aD5cXGQrKVxcLCg/PGhlaWdodD5cXGQrKVxcXSQvLmV4ZWMocmVjdClcbiAgaWYgKCFtYXQpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRFbGVtZW50Q29vcmRpbmF0ZXNFcnJvcihcInRoZSBlbGVtZW50J3MgcmVjdCBhdHRyaWJ1dGUgaXMgbWFsZm9ybWVkXCIpO1xuICB9XG4gIGNvbnN0IHt4LCB5LCB3aWR0aCwgaGVpZ2h0fSA9IG1hdC5ncm91cHM7XG4gIHJldHVybiB7XG4gICAgeDogTnVtYmVyLnBhcnNlSW50KHgpLFxuICAgIHk6IE51bWJlci5wYXJzZUludCh5KSxcbiAgICB3aWR0aDogTnVtYmVyLnBhcnNlSW50KHdpZHRoKSxcbiAgICBoZWlnaHQ6IE51bWJlci5wYXJzZUludChoZWlnaHQpXG4gIH07XG59O1xuXG5jb21tYW5kcy5zZXRWYWx1ZSA9IGNvbW1hbmRzLnJlcGxhY2VWYWx1ZSA9IGNvbW1hbmRzLnNldFZhbHVlSW1tZWRpYXRlID0gYXN5bmMgZnVuY3Rpb24gc2V0VmFsdWUgKHZhbHVlcywgZWxlbWVudElkKSB7XG4gIGNvbnN0IHV1aWQgPSBlbGVtZW50SWQ7XG4gIGNvbnN0IF92ID0gdmFsdWVzWzBdO1xuICBjb25zdCB7eCwgeSwgd2lkdGgsIGhlaWdodH0gPSB0aGlzLl9maW5kRWxSZWN0KHV1aWQpO1xuICBjb25zdCBfeCA9IHggKyB3aWR0aCAvIDI7XG4gIGNvbnN0IF95ID0geSArIGhlaWdodCAvIDI7XG4gIGF3YWl0IHdhaXQ0c2VjKDAuNSk7XG4gIGFwaXMubW91c2VfY2xpY2soX3gsIF95LCAxKTtcbiAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgYXBpcy5rZXlib2FyZF90YXBLZXkoJ2EnLCA0KTsgLy8gY29udHJvbCArIEFcbiAgYXdhaXQgd2FpdDRzZWMoMC4xKTtcbiAgYXBpcy5rZXlib2FyZF90YXBLZXlDb2RlKDY1NTM1LCAwKTsgLy8gZGVsZXRlXG4gIGF3YWl0IHdhaXQ0c2VjKDAuNSk7XG4gIGFwaXMua2V5Ym9hcmRfdHlwZVN0cmluZ0NvcHlQYXN0ZShfdik7XG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMuY2xpY2sgPSBhc3luYyBmdW5jdGlvbiBjbGljayAoZWxlbWVudElkKSB7XG4gIGNvbnN0IHV1aWQgPSBlbGVtZW50SWQ7XG4gIGNvbnN0IHt4LCB5LCB3aWR0aCwgaGVpZ2h0fSA9IHRoaXMuX2ZpbmRFbFJlY3QodXVpZCk7XG4gIGNvbnN0IF94ID0geCArIHdpZHRoIC8gMjtcbiAgY29uc3QgX3kgPSB5ICsgaGVpZ2h0IC8gMjtcbiAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgYXBpcy5tb3VzZV9jbGljayhfeCwgX3ksIDEpO1xuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbW1hbmRzLnByZXNzS2V5Q29kZSA9IGZ1bmN0aW9uIHByZXNzS2V5Q29kZSAoa2V5Y29kZSwgbWV0YXN0YXRlKSB7XG4gIG1ldGFzdGF0ZSB8fCAobWV0YXN0YXRlID0gMCk7XG4gIGlmIChrZXljb2RlID49IDApIHtcbiAgICBhcGlzLmtleWJvYXJkX3RhcEtleUNvZGUoa2V5Y29kZSwgbWV0YXN0YXRlKTtcbiAgfSBlbHNlIHtcbiAgICBhcGlzLmtleWJvYXJkX3RhcEtleShTdHJpbmcuZnJvbUNoYXJDb2RlKC1rZXljb2RlKSwgbWV0YXN0YXRlKTtcbiAgfVxuICBcbiAgcmV0dXJuIG51bGw7XG59XG5cbmNvbW1hbmRzLmxvbmdQcmVzc0tleUNvZGUgPSBhc3luYyBmdW5jdGlvbiBsb25nUHJlc3NLZXlDb2RlIChrZXljb2RlLCBtZXRhc3RhdGUpIHtcbiAgbWV0YXN0YXRlIHx8IChtZXRhc3RhdGUgPSAwKTtcbiAgY29uc3QgaXNLZXlDb2RlID0ga2V5Y29kZSA+PSAwO1xuICBpZiAoaXNLZXlDb2RlKSB7XG4gICAgYXBpcy5rZXlib2FyZF90b2dnbGVLZXlDb2RlKGtleWNvZGUsIHRydWUsIG1ldGFzdGF0ZSk7XG4gICAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgICBhcGlzLmtleWJvYXJkX3RvZ2dsZUtleUNvZGUoa2V5Y29kZSwgZmFsc2UsIG1ldGFzdGF0ZSk7XG4gIH0gZWxzZSB7XG4gICAgYXBpcy5rZXlib2FyZF90b2dnbGVLZXkoU3RyaW5nLmZyb21DaGFyQ29kZSgta2V5Y29kZSksIHRydWUsIG1ldGFzdGF0ZSk7XG4gICAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgICBhcGlzLmtleWJvYXJkX3RvZ2dsZUtleShTdHJpbmcuZnJvbUNoYXJDb2RlKC1rZXljb2RlKSwgZmFsc2UsIG1ldGFzdGF0ZSk7XG4gIH1cbiAgXG4gIHJldHVybiBudWxsO1xufVxuXG5jb21tYW5kcy5nZXRQcm9wZXJ0eSA9IGNvbW1hbmRzLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uIGdldFByb3BlcnR5IChuYW1lLCBlbGVtZW50SWQpIHtcbiAgY29uc3Qgc3RyRWwgPSB0aGlzLl9jYWNoZS5nZXQoZWxlbWVudElkKTtcbiAgaWYgKCFzdHJFbCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKFwidGhlIGVsZW1lbnQgZG9lc24ndCBleGlzdFwiKTtcbiAgfVxuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHN0ckVsKTtcbiAgaWYgKCFkb2MuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihcInRoZSBlbGVtZW50IGhhcyBubyBhdHRyaWJ1dGVzXCIpO1xuICB9XG4gIGxldCBhdHRycyA9IEFycmF5LmZyb20oZG9jLmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzKTtcbiAgYXR0cnMgPSBhdHRycy5yZWR1Y2UoKHByZXYsIGN1cnIpID0+IHtcbiAgICBwcmV2W2N1cnIubmFtZV0gPSBjdXJyLnZhbHVlO1xuICAgIHJldHVybiBwcmV2O1xuICB9LCB7fSk7XG4gIHJldHVybiBhdHRyc1tuYW1lXTtcbn1cblxuY29tbWFuZHMuZ2V0RWxlbWVudFJlY3QgPSBmdW5jdGlvbiBnZXRFbGVtZW50UmVjdCAoZWxlbWVudElkKSB7XG4gIGNvbnN0IHJlY3QgPSB0aGlzLmdldFByb3BlcnR5KCdyZWN0JywgZWxlbWVudElkKTtcbiAgaWYgKCFyZWN0KSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkRWxlbWVudENvb3JkaW5hdGVzRXJyb3IoXCJ0aGUgZWxlbWVudCBoYXMgbm8gcmVjdCBhdHRyaWJ1dGVcIik7XG4gIH1cbiAgY29uc3QgbWF0ID0gL15cXFsoPzx4PlxcZCspXFwsKD88eT5cXGQrKVxcLCg/PHdpZHRoPlxcZCspXFwsKD88aGVpZ2h0PlxcZCspXFxdJC8uZXhlYyhyZWN0KVxuICBpZiAoIW1hdCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEVsZW1lbnRDb29yZGluYXRlc0Vycm9yKFwidGhlIGVsZW1lbnQncyByZWN0IGF0dHJpYnV0ZSBpcyBtYWxmb3JtZWRcIik7XG4gIH1cbiAgY29uc3Qge3gsIHksIHdpZHRoLCBoZWlnaHR9ID0gbWF0Lmdyb3VwcztcbiAgcmV0dXJuIHtcbiAgICB4OiBOdW1iZXIucGFyc2VJbnQoeCksXG4gICAgeTogTnVtYmVyLnBhcnNlSW50KHkpLFxuICAgIHdpZHRoOiBOdW1iZXIucGFyc2VJbnQod2lkdGgpLFxuICAgIGhlaWdodDogTnVtYmVyLnBhcnNlSW50KGhlaWdodClcbiAgfTtcbn07XG5cbmNvbW1hbmRzLmdldFNpemUgPSBmdW5jdGlvbiBnZXRTaXplIChlbGVtZW50SWQpIHtcbiAgY29uc3QgcmVjdCA9IHRoaXMuZ2V0RWxlbWVudFJlY3QoZWxlbWVudElkKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aDogcmVjdC53aWR0aCxcbiAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0XG4gIH07XG59O1xuXG5jb21tYW5kcy5jbGVhciA9IGFzeW5jIGZ1bmN0aW9uIGNsZWFyIChlbGVtZW50SWQpIHtcbiAgYXdhaXQgdGhpcy5jbGljayhlbGVtZW50SWQpO1xuICBhd2FpdCB3YWl0NHNlYygwLjUpO1xuICBhcGlzLmtleWJvYXJkX3RhcEtleSgnYScsIDQpOyAvLyBjb250cm9sICsgQVxuICBhd2FpdCB3YWl0NHNlYygwLjEpO1xuICBhcGlzLmtleWJvYXJkX3RhcEtleUNvZGUoNjU1MzUsIDApOyAvLyBkZWxldGVcbn07XG5cbmNvbW1hbmRzLmdldE5hbWUgPSBmdW5jdGlvbiBnZXROYW1lIChlbGVtZW50SWQpIHtcbiAgY29uc3QgbmFtZSA9IHRoaXMuZ2V0UHJvcGVydHkoJ25hbWUnLCBlbGVtZW50SWQpO1xuICByZXR1cm4gbmFtZTtcbn1cblxuY29tbWFuZHMuZ2V0VGV4dCA9IGZ1bmN0aW9uIGdldFRleHQgKGVsZW1lbnRJZCkge1xuICBjb25zdCB0ZXh0ID0gdGhpcy5nZXRQcm9wZXJ0eSgndGV4dCcsIGVsZW1lbnRJZCk7XG4gIHJldHVybiB0ZXh0O1xufVxuXG5jb21tYW5kcy5saW51eEdldERpc3BsYXlTaXplID0gZnVuY3Rpb24gbGludXhHZXREaXNwbGF5U2l6ZSAoKSB7XG4gIHJldHVybiBhcGlzLmNfZ2V0TWFpbkRpc3BsYXlTaXplKCk7XG59O1xuXG5jb21tYW5kcy5saW51eE1vdXNlTW92ZSA9IGZ1bmN0aW9uIGxpbnV4TW91c2VNb3ZlIChvcHRzID0ge30pIHtcbiAgY29uc3Qge3gsIHl9ID0gb3B0cztcbiAgY29uc3QgX3ggPSBOdW1iZXIucGFyc2VJbnQoeCk7XG4gIGNvbnN0IF95ID0gTnVtYmVyLnBhcnNlSW50KHkpO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUoX3gpIHx8ICF1dGlsLmhhc1ZhbHVlKF95KSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKFwicGFyYW1ldGVyIHgsIHkgYXJlIHJlcXVpcmVkXCIpO1xuICB9XG4gIGFwaXMubW91c2VfbW92ZShfeCwgX3kpO1xuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbW1hbmRzLmxpbnV4TW91c2VTd2lwZSA9IGZ1bmN0aW9uIGxpbnV4TW91c2VTd2lwZSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtzeCwgc3ksIGV4LCBleX0gPSBvcHRzO1xuICBjb25zdCBfc3ggPSBOdW1iZXIucGFyc2VJbnQoc3gpO1xuICBjb25zdCBfc3kgPSBOdW1iZXIucGFyc2VJbnQoc3kpO1xuICBjb25zdCBfZXggPSBOdW1iZXIucGFyc2VJbnQoZXgpO1xuICBjb25zdCBfZXkgPSBOdW1iZXIucGFyc2VJbnQoZXkpO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUoX3N4KSB8fCAhdXRpbC5oYXNWYWx1ZShfc3kpIHx8ICF1dGlsLmhhc1ZhbHVlKF9leCkgfHwgIXV0aWwuaGFzVmFsdWUoX2V5KSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKFwicGFyYW1ldGVyIHN4LCBzeSwgZXgsIGV5IGFyZSByZXF1aXJlZFwiKTtcbiAgfVxuICBhcGlzLm1vdXNlX3N3aXBlKF9zeCwgX3N5LCBfZXgsIF9leSk7XG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMubGludXhSaWdodENsaWNrID0gZnVuY3Rpb24gbGludXhSaWdodENsaWNrIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2VsZW1lbnRJZH0gPSBvcHRzO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUoZWxlbWVudElkKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKFwicGFyYW1ldGVyIGVsZW1lbnRJZCBpcyByZXF1aXJlZFwiKTtcbiAgfVxuICBjb25zdCByZWN0ID0gdGhpcy5nZXRFbGVtZW50UmVjdChlbGVtZW50SWQpO1xuICBjb25zdCB4ID0gcmVjdC54ICsgcmVjdC53aWR0aCAvIDI7XG4gIGNvbnN0IHkgPSByZWN0LnkgKyByZWN0LmhlaWdodCAvIDI7XG4gIGFwaXMubW91c2VfY2xpY2soeCwgeSwgMyk7XG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMubGludXhEb3VibGVDbGljayA9IGZ1bmN0aW9uIGxpbnV4RG91YmxlQ2xpY2sgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7ZWxlbWVudElkfSA9IG9wdHM7XG4gIGlmICghdXRpbC5oYXNWYWx1ZShlbGVtZW50SWQpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoXCJwYXJhbWV0ZXIgZWxlbWVudElkIGlzIHJlcXVpcmVkXCIpO1xuICB9XG4gIGNvbnN0IHJlY3QgPSB0aGlzLmdldEVsZW1lbnRSZWN0KGVsZW1lbnRJZCk7XG4gIGNvbnN0IHggPSByZWN0LnggKyByZWN0LndpZHRoIC8gMjtcbiAgY29uc3QgeSA9IHJlY3QueSArIHJlY3QuaGVpZ2h0IC8gMjtcbiAgYXBpcy5tb3VzZV9kb3VibGVDbGljayh4LCB5LCAxKTtcbiAgcmV0dXJuIG51bGw7XG59O1xuXG5jb21tYW5kcy5saW51eE1vdXNlU2Nyb2xsID0gZnVuY3Rpb24gbGludXhNb3VzZVNjcm9sbCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHttb3ZlTGVmdFN0ZXBzLCBtb3ZlVXBTdGVwc30gPSBvcHRzO1xuICBsZXQgX21vdmVMZWZ0U3RlcHMgPSBOdW1iZXIucGFyc2VJbnQobW92ZUxlZnRTdGVwcyk7XG4gIGxldCBfbW92ZVVwU3RlcHMgPSBOdW1iZXIucGFyc2VJbnQobW92ZVVwU3RlcHMpO1xuICBfbW92ZUxlZnRTdGVwcyA9ICFfbW92ZUxlZnRTdGVwcz8gMDogX21vdmVMZWZ0U3RlcHM7XG4gIF9tb3ZlVXBTdGVwcyA9ICFfbW92ZVVwU3RlcHM/IDA6IF9tb3ZlVXBTdGVwcztcbiAgaWYgKF9tb3ZlTGVmdFN0ZXBzICE9IDAgfHwgX21vdmVVcFN0ZXBzICE9IDApIHtcbiAgICBhcGlzLm1vdXNlX3Njcm9sbF94X3koX21vdmVMZWZ0U3RlcHMsIF9tb3ZlVXBTdGVwcyk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxpbnV4Q29weSA9IGZ1bmN0aW9uIGxpbnV4Q29weSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtzdHJ9ID0gb3B0cztcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKHN0cikpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihcInBhcmFtZXRlciBzdHIgaXMgcmVxdWlyZWRcIik7XG4gIH1cbiAgYXBpcy5rZXlib2FyZF9jb3B5KHN0cik7XG59O1xuXG5jb21tYW5kcy5saW51eEdldENsaXBib2FyZCA9IGZ1bmN0aW9uIGxpbnV4R2V0Q2xpcGJvYXJkICgpIHtcbiAgcmV0dXJuIGFwaXMua2V5Ym9hcmRfZ2V0Q2xpcGJvYXJkQ29udGVudCgpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZXN0dXJlcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
