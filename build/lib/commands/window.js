"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _privateapis = _interopRequireDefault(require("@stdspa/stdspalinux_temp/dist/privateapis"));

var _logger = _interopRequireDefault(require("../logger"));

var _xpath = _interopRequireDefault(require("xpath.js"));

var _xmldom = require("xmldom");

var _baseDriver = require("@appium/base-driver");

const commands = {};

commands.getWindowHandle = function getWindowHandle() {
  var _this$_win;

  return (_this$_win = this._win) === null || _this$_win === void 0 ? void 0 : _this$_win.wid;
};

commands.getWindowHandles = function getWindowHandles() {
  const appName = this.appName;

  const pids = _privateapis.default.app_running(appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[${xpath} and @InputOutput="true"]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    return [];
  }

  const wids = [];

  for (const node of nodes) {
    if (!node.attributes) {
      continue;
    }

    const attrs = Array.from(node.attributes);

    for (const attr of attrs) {
      if (attr.name == "wid") {
        wids.push(Number.parseInt(attr.value));
      }
    }
  }

  return wids;
};

commands._getWinAndPid_FromWinName = function (windowName) {
  const pids = _privateapis.default.app_running(this.appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${this.appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[(${xpath}) and @InputOutput="true" and (@name="${windowName}" or contains(concat(" ", @class, " "), "${" " + windowName + " "}"))]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  let _nodes = [];

  for (const node of nodes) {
    if (!node.attributes) {
      continue;
    }

    const attrs = Array.from(node.attributes);
    const _node = {};

    for (const attr of attrs) {
      _node[attr.name] = attr.value;
    }

    _nodes.push(_node);
  }

  _nodes = _nodes.filter(p => (p.name || p.class) && p.pid && p.wid);

  if (_nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  _nodes.sort((a, b) => {
    const av = a.name == windowName ? -1 : 1;
    const bv = b.name == windowName ? -1 : 1;
    return av - bv;
  });

  for (const _node of _nodes) {
    const _pid = Number.parseInt(_node.pid);

    if (_privateapis.default.a11y_checkWindowExists(windowName, _pid)) {
      return {
        pid: _pid,
        wid: Number.parseInt(_node.wid),
        name: windowName
      };
    }
  }

  throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
};

commands._getWinAndPid_FromWinId = function (wid) {
  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  const xpath = `//*[@wid="${wid}" and @InputOutput="true"]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  let node = nodes[0];
  const attrs = Array.from(node.attributes);
  const _node = {};

  for (const attr of attrs) {
    _node[attr.name] = attr.value;
  }

  node = _node;

  if (!node.name || !node.pid || !node.wid) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  if (!_privateapis.default.a11y_checkWindowExists(node.name, Number.parseInt(node.pid))) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  return {
    pid: Number.parseInt(node.pid),
    wid: Number.parseInt(node.wid),
    name: node.name
  };
};

function validateName(name) {
  if (!name) {
    return name;
  }

  for (let i = 0; i < name.length; ++i) {
    if (name[i] < '0' || name[i] > '9') {
      return name;
    }
  }

  return null;
}

function validateHandle(handle) {
  if (!handle) {
    return handle;
  }

  for (let i = 0; i < handle.length; ++i) {
    if (handle[i] < '0' || handle[i] > '9') {
      return null;
    }
  }

  return handle;
}

commands.setWindow = function setWindow(name, handle) {
  handle = validateHandle(handle);
  name = validateName(name);

  if (name) {
    const win = this._getWinAndPid_FromWinName(name);

    this._win = win;
  } else if (handle) {
    const win = this._getWinAndPid_FromWinId(handle);

    this._win = win;
  } else {
    throw new _baseDriver.errors.UnknownError("setWindow both name and handle don't have a value");
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93aW5kb3cuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJnZXRXaW5kb3dIYW5kbGUiLCJfd2luIiwid2lkIiwiZ2V0V2luZG93SGFuZGxlcyIsImFwcE5hbWUiLCJwaWRzIiwiYXBpcyIsImFwcF9ydW5uaW5nIiwibGVuZ3RoIiwiZXJyb3JzIiwiTm9TdWNoV2luZG93RXJyb3IiLCJ3aW5IaWVyYWNoeSIsImFwcF9nZXRXaW5kb3dIaWVyYWNoeSIsImRvYyIsImRvbSIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwibWFwIiwicGlkIiwiam9pbiIsIm5vZGVzIiwid2lkcyIsIm5vZGUiLCJhdHRyaWJ1dGVzIiwiYXR0cnMiLCJBcnJheSIsImZyb20iLCJhdHRyIiwibmFtZSIsInB1c2giLCJOdW1iZXIiLCJwYXJzZUludCIsInZhbHVlIiwiX2dldFdpbkFuZFBpZF9Gcm9tV2luTmFtZSIsIndpbmRvd05hbWUiLCJfbm9kZXMiLCJfbm9kZSIsImZpbHRlciIsInAiLCJjbGFzcyIsInNvcnQiLCJhIiwiYiIsImF2IiwiYnYiLCJfcGlkIiwiYTExeV9jaGVja1dpbmRvd0V4aXN0cyIsIl9nZXRXaW5BbmRQaWRfRnJvbVdpbklkIiwidmFsaWRhdGVOYW1lIiwiaSIsInZhbGlkYXRlSGFuZGxlIiwiaGFuZGxlIiwic2V0V2luZG93Iiwid2luIiwiVW5rbm93bkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjs7QUFFQUEsUUFBUSxDQUFDQyxlQUFULEdBQTJCLFNBQVNBLGVBQVQsR0FBNEI7QUFBQTs7QUFDckQsdUJBQU8sS0FBS0MsSUFBWiwrQ0FBTyxXQUFXQyxHQUFsQjtBQUNELENBRkQ7O0FBSUFILFFBQVEsQ0FBQ0ksZ0JBQVQsR0FBNEIsU0FBU0EsZ0JBQVQsR0FBNkI7QUFDdkQsUUFBTUMsT0FBTyxHQUFHLEtBQUtBLE9B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QUFULENBQXdCQyxNQUF4QixFQUFnQztBQUM5QixNQUFJLENBQUNBLE1BQUwsRUFBYTtBQUNYLFdBQU9BLE1BQVA7QUFDRDs7QUFDRCxPQUFJLElBQUlGLENBQUMsR0FBQyxDQUFWLEVBQWFBLENBQUMsR0FBQ0UsTUFBTSxDQUFDM0MsTUFBdEIsRUFBOEIsRUFBRXlDLENBQWhDLEVBQW1DO0FBQ2pDLFFBQUlFLE1BQU0sQ0FBQ0YsQ0FBRCxDQUFOLEdBQVksR0FBWixJQUFtQkUsTUFBTSxDQUFDRixDQUFELENBQU4sR0FBWSxHQUFuQyxFQUF3QztBQUN0QyxhQUFPLElBQVA7QUFDRDtBQUNGOztBQUNELFNBQU9FLE1BQVA7QUFDRDs7QUFFRHBELFFBQVEsQ0FBQ3FELFNBQVQsR0FBcUIsU0FBU0EsU0FBVCxDQUFvQnhCLElBQXBCLEVBQTBCdUIsTUFBMUIsRUFBa0M7QUFDckRBLEVBQUFBLE1BQU0sR0FBR0QsY0FBYyxDQUFDQyxNQUFELENBQXZCO0FBQ0F2QixFQUFBQSxJQUFJLEdBQUdvQixZQUFZLENBQUNwQixJQUFELENBQW5COztBQUNBLE1BQUlBLElBQUosRUFBVTtBQUNSLFVBQU15QixHQUFHLEdBQUcsS0FBS3BCLHlCQUFMLENBQStCTCxJQUEvQixDQUFaOztBQUNBLFNBQUszQixJQUFMLEdBQVlvRCxHQUFaO0FBQ0QsR0FIRCxNQUdPLElBQUlGLE1BQUosRUFBWTtBQUNqQixVQUFNRSxHQUFHLEdBQUcsS0FBS04sdUJBQUwsQ0FBNkJJLE1BQTdCLENBQVo7O0FBQ0EsU0FBS2xELElBQUwsR0FBWW9ELEdBQVo7QUFDRCxHQUhNLE1BR0E7QUFDTCxVQUFNLElBQUk1QyxtQkFBTzZDLFlBQVgsQ0FBd0IsbURBQXhCLENBQU47QUFDRDtBQUNGLENBWkQ7O2VBY2V2RCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFwaXMgZnJvbSAnQHN0ZHNwYS9zdGRzcGFsaW51eF90ZW1wL2Rpc3QvcHJpdmF0ZWFwaXMnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHNlbGVjdCBmcm9tICd4cGF0aC5qcyc7XG5pbXBvcnQgeyBET01QYXJzZXIgYXMgZG9tIH0gZnJvbSAneG1sZG9tJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ0BhcHBpdW0vYmFzZS1kcml2ZXInO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGUgPSBmdW5jdGlvbiBnZXRXaW5kb3dIYW5kbGUgKCkge1xuICByZXR1cm4gdGhpcy5fd2luPy53aWQ7XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGVzID0gZnVuY3Rpb24gZ2V0V2luZG93SGFuZGxlcyAoKSB7XG4gIGNvbnN0IGFwcE5hbWUgPSB0aGlzLmFwcE5hbWU7XG4gIGNvbnN0IHBpZHMgPSBhcGlzLmFwcF9ydW5uaW5nKGFwcE5hbWUpO1xuICBpZiAoIXBpZHMgfHwgcGlkcy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGBhcHBsaWNhdGlvbiAke2FwcE5hbWV9IGlzIG5vdCBydW5uaW5nYCk7XG4gIH1cbiAgY29uc3Qgd2luSGllcmFjaHkgPSBhcGlzLmFwcF9nZXRXaW5kb3dIaWVyYWNoeSgpO1xuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHdpbkhpZXJhY2h5KTtcbiAgbGV0IHhwYXRoID0gcGlkcy5tYXAocGlkID0+IGBAcGlkPVwiJHtwaWR9XCJgKS5qb2luKFwiIG9yIFwiKTtcbiAgeHBhdGggPSBgLy8qWyR7eHBhdGh9IGFuZCBASW5wdXRPdXRwdXQ9XCJ0cnVlXCJdYDtcbiAgY29uc3Qgbm9kZXMgPSBzZWxlY3QoZG9jLCB4cGF0aCk7XG4gIGlmICghbm9kZXMgfHwgbm9kZXMubGVuZ3RoID09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgY29uc3Qgd2lkcyA9IFtdO1xuICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHtcbiAgICBpZiAoIW5vZGUuYXR0cmlidXRlcykge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGNvbnN0IGF0dHJzID0gQXJyYXkuZnJvbShub2RlLmF0dHJpYnV0ZXMpO1xuICAgIGZvciAoY29uc3QgYXR0ciBvZiBhdHRycykge1xuICAgICAgaWYgKGF0dHIubmFtZSA9PSBcIndpZFwiKSB7XG4gICAgICAgIHdpZHMucHVzaChOdW1iZXIucGFyc2VJbnQoYXR0ci52YWx1ZSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gd2lkcztcbn1cblxuY29tbWFuZHMuX2dldFdpbkFuZFBpZF9Gcm9tV2luTmFtZSA9IGZ1bmN0aW9uICh3aW5kb3dOYW1lKSB7XG4gIGNvbnN0IHBpZHMgPSBhcGlzLmFwcF9ydW5uaW5nKHRoaXMuYXBwTmFtZSk7XG4gIGlmICghcGlkcyB8fCBwaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYGFwcGxpY2F0aW9uICR7dGhpcy5hcHBOYW1lfSBpcyBub3QgcnVubmluZ2ApO1xuICB9XG4gIGNvbnN0IHdpbkhpZXJhY2h5ID0gYXBpcy5hcHBfZ2V0V2luZG93SGllcmFjaHkoKTtcbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyh3aW5IaWVyYWNoeSk7XG4gIGxldCB4cGF0aCA9IHBpZHMubWFwKHBpZCA9PiBgQHBpZD1cIiR7cGlkfVwiYCkuam9pbihcIiBvciBcIik7XG4gIHhwYXRoID0gYC8vKlsoJHt4cGF0aH0pIGFuZCBASW5wdXRPdXRwdXQ9XCJ0cnVlXCIgYW5kIChAbmFtZT1cIiR7d2luZG93TmFtZX1cIiBvciBjb250YWlucyhjb25jYXQoXCIgXCIsIEBjbGFzcywgXCIgXCIpLCBcIiR7XCIgXCIgKyB3aW5kb3dOYW1lICsgXCIgXCJ9XCIpKV1gO1xuICBjb25zdCBub2RlcyA9IHNlbGVjdChkb2MsIHhwYXRoKTtcbiAgaWYgKCFub2RlcyB8fCBub2Rlcy5sZW5ndGggPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgJHt3aW5kb3dOYW1lfSBkb2Vzbid0IHByZXNlbnRgKTtcbiAgfVxuICBsZXQgX25vZGVzID0gW107XG4gIGZvciAoY29uc3Qgbm9kZSBvZiBub2Rlcykge1xuICAgIGlmICghbm9kZS5hdHRyaWJ1dGVzKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgY29uc3QgYXR0cnMgPSBBcnJheS5mcm9tKG5vZGUuYXR0cmlidXRlcyk7XG4gICAgY29uc3QgX25vZGUgPSB7fTtcbiAgICBmb3IgKGNvbnN0IGF0dHIgb2YgYXR0cnMpIHtcbiAgICAgIF9ub2RlW2F0dHIubmFtZV0gPSBhdHRyLnZhbHVlO1xuICAgIH1cbiAgICBfbm9kZXMucHVzaChfbm9kZSk7XG4gIH1cbiAgX25vZGVzID0gX25vZGVzLmZpbHRlcihwID0+IChwLm5hbWUgfHwgcC5jbGFzcykgJiYgcC5waWQgJiYgcC53aWQpO1xuICBpZiAoX25vZGVzLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyAke3dpbmRvd05hbWV9IGRvZXNuJ3QgcHJlc2VudGApO1xuICB9XG4gIF9ub2Rlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgY29uc3QgYXYgPSBhLm5hbWUgPT0gd2luZG93TmFtZT8gLTE6IDE7XG4gICAgY29uc3QgYnYgPSBiLm5hbWUgPT0gd2luZG93TmFtZT8gLTE6IDE7XG4gICAgcmV0dXJuIGF2IC0gYnY7XG4gIH0pO1xuICBmb3IgKGNvbnN0IF9ub2RlIG9mIF9ub2Rlcykge1xuICAgIGNvbnN0IF9waWQgPSBOdW1iZXIucGFyc2VJbnQoX25vZGUucGlkKTtcbiAgICBpZiAoYXBpcy5hMTF5X2NoZWNrV2luZG93RXhpc3RzKHdpbmRvd05hbWUsIF9waWQpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwaWQ6IF9waWQsXG4gICAgICAgIHdpZDogTnVtYmVyLnBhcnNlSW50KF9ub2RlLndpZCksXG4gICAgICAgIG5hbWU6IHdpbmRvd05hbWVcbiAgICAgIH07XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgJHt3aW5kb3dOYW1lfSBkb2Vzbid0IHByZXNlbnRgKTtcbn1cblxuY29tbWFuZHMuX2dldFdpbkFuZFBpZF9Gcm9tV2luSWQgPSBmdW5jdGlvbiAod2lkKSB7XG4gIGNvbnN0IHdpbkhpZXJhY2h5ID0gYXBpcy5hcHBfZ2V0V2luZG93SGllcmFjaHkoKTtcbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyh3aW5IaWVyYWNoeSk7XG4gIGNvbnN0IHhwYXRoID0gYC8vKltAd2lkPVwiJHt3aWR9XCIgYW5kIEBJbnB1dE91dHB1dD1cInRydWVcIl1gO1xuICBjb25zdCBub2RlcyA9IHNlbGVjdChkb2MsIHhwYXRoKTtcbiAgaWYgKCFub2RlcyB8fCBub2Rlcy5sZW5ndGggPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgd2lkPSR7d2lkfSBkb2Vzbid0IHByZXNlbnRgKTtcbiAgfVxuICBsZXQgbm9kZSA9IG5vZGVzWzBdO1xuICBjb25zdCBhdHRycyA9IEFycmF5LmZyb20obm9kZS5hdHRyaWJ1dGVzKTtcbiAgY29uc3QgX25vZGUgPSB7fTtcbiAgZm9yIChjb25zdCBhdHRyIG9mIGF0dHJzKSB7XG4gICAgX25vZGVbYXR0ci5uYW1lXSA9IGF0dHIudmFsdWU7XG4gIH1cbiAgbm9kZSA9IF9ub2RlO1xuICBpZiAoIW5vZGUubmFtZSB8fCAhbm9kZS5waWQgfHwgIW5vZGUud2lkKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyB3aWQ9JHt3aWR9IGRvZXNuJ3QgcHJlc2VudGApO1xuICB9XG4gIGlmICghYXBpcy5hMTF5X2NoZWNrV2luZG93RXhpc3RzKG5vZGUubmFtZSwgTnVtYmVyLnBhcnNlSW50KG5vZGUucGlkKSkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93IHdpZD0ke3dpZH0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBwaWQ6IE51bWJlci5wYXJzZUludChub2RlLnBpZCksXG4gICAgd2lkOiBOdW1iZXIucGFyc2VJbnQobm9kZS53aWQpLFxuICAgIG5hbWU6IG5vZGUubmFtZVxuICB9O1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZU5hbWUobmFtZSkge1xuICBpZiAoIW5hbWUpIHtcbiAgICByZXR1cm4gbmFtZTtcbiAgfVxuICBmb3IobGV0IGk9MDsgaTxuYW1lLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKG5hbWVbaV0gPCAnMCcgfHwgbmFtZVtpXSA+ICc5Jykge1xuICAgICAgcmV0dXJuIG5hbWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUhhbmRsZShoYW5kbGUpIHtcbiAgaWYgKCFoYW5kbGUpIHtcbiAgICByZXR1cm4gaGFuZGxlO1xuICB9XG4gIGZvcihsZXQgaT0wOyBpPGhhbmRsZS5sZW5ndGg7ICsraSkge1xuICAgIGlmIChoYW5kbGVbaV0gPCAnMCcgfHwgaGFuZGxlW2ldID4gJzknKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGhhbmRsZTtcbn1cblxuY29tbWFuZHMuc2V0V2luZG93ID0gZnVuY3Rpb24gc2V0V2luZG93IChuYW1lLCBoYW5kbGUpIHtcbiAgaGFuZGxlID0gdmFsaWRhdGVIYW5kbGUoaGFuZGxlKTtcbiAgbmFtZSA9IHZhbGlkYXRlTmFtZShuYW1lKTtcbiAgaWYgKG5hbWUpIHtcbiAgICBjb25zdCB3aW4gPSB0aGlzLl9nZXRXaW5BbmRQaWRfRnJvbVdpbk5hbWUobmFtZSk7XG4gICAgdGhpcy5fd2luID0gd2luO1xuICB9IGVsc2UgaWYgKGhhbmRsZSkge1xuICAgIGNvbnN0IHdpbiA9IHRoaXMuX2dldFdpbkFuZFBpZF9Gcm9tV2luSWQoaGFuZGxlKTtcbiAgICB0aGlzLl93aW4gPSB3aW47XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoXCJzZXRXaW5kb3cgYm90aCBuYW1lIGFuZCBoYW5kbGUgZG9uJ3QgaGF2ZSBhIHZhbHVlXCIpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzOyJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3dpbmRvdy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
