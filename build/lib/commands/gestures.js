"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _support = require("@appium/support");

var _baseDriver = require("@appium/base-driver");

var _xmldom = require("xmldom");

var _privateapis = _interopRequireDefault(require("@stdspa/stdspalinux_temp/dist/privateapis"));

var _utils = require("../utils");

const commands = {};

commands._findElRect = function (uuid) {
  const strEl = this._cache.get(uuid);

  if (!strEl) {
    throw new _baseDriver.errors.NoSuchElementError("the element doesn't exist");
  }

  const doc = new _xmldom.DOMParser().parseFromString(strEl);

  if (!doc.documentElement.attributes) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError('the element has no rect attribute');
  }

  let attrs = Array.from(doc.documentElement.attributes);
  attrs = attrs.reduce((prev, curr) => {
    prev[curr.name] = curr.value;
    return prev;
  }, {});
  const rect = attrs.rect;

  if (!rect) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError('the element has no rect attribute');
  }

  const mat = /^\[(?<x>\d+),(?<y>\d+),(?<width>\d+),(?<height>\d+)\]$/.exec(rect);

  if (!mat) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element's rect attribute is malformed");
  }

  const {
    x,
    y,
    width,
    height
  } = mat.groups;
  return {
    x: Number.parseInt(x, 10),
    y: Number.parseInt(y, 10),
    width: Number.parseInt(width, 10),
    height: Number.parseInt(height, 10)
  };
};

commands.setValue = commands.replaceValue = commands.setValueImmediate = async function setValue(values, elementId) {
  const uuid = elementId;
  const _v = values[0];

  const {
    x,
    y,
    width,
    height
  } = this._findElRect(uuid);

  const _x = x + width / 2;

  const _y = y + height / 2;

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.mouse_click(_x, _y, 1);

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.keyboard_tapKey('a', 4);

  await (0, _utils.wait4sec)(0.1);

  _privateapis.default.keyboard_tapKeyCode(65535, 0);

  await (0, _utils.wait4sec)(0.5);

  for (let i in values) {
    await (0, _utils.wait4sec)(0.1);
    
    _privateapis.default.keyboard_typeStringCopyPaste(values[i]);
  }

  return null;
};

commands.click = async function click(elementId) {
  const uuid = elementId;

  const {
    x,
    y,
    width,
    height
  } = this._findElRect(uuid);

  const _x = x + width / 2;

  const _y = y + height / 2;

  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.mouse_click(_x, _y, 1);

  return null;
};

commands.pressKeyCode = function pressKeyCode(keycode, metastate) {
  metastate || (metastate = 0);

  if (keycode >= 0) {
    _privateapis.default.keyboard_tapKeyCode(keycode, metastate);
  } else {
    _privateapis.default.keyboard_tapKey(String.fromCharCode(-keycode), metastate);
  }

  return null;
};

commands.longPressKeyCode = async function longPressKeyCode(keycode, metastate) {
  metastate || (metastate = 0);
  const isKeyCode = keycode >= 0;

  if (isKeyCode) {
    _privateapis.default.keyboard_toggleKeyCode(keycode, true, metastate);

    await (0, _utils.wait4sec)(0.5);

    _privateapis.default.keyboard_toggleKeyCode(keycode, false, metastate);
  } else {
    _privateapis.default.keyboard_toggleKey(String.fromCharCode(-keycode), true, metastate);

    await (0, _utils.wait4sec)(0.5);

    _privateapis.default.keyboard_toggleKey(String.fromCharCode(-keycode), false, metastate);
  }

  return null;
};

commands.getProperty = commands.getAttribute = function getProperty(name, elementId) {
  const strEl = this._cache.get(elementId);

  if (!strEl) {
    throw new _baseDriver.errors.NoSuchElementError("the element doesn't exist");
  }

  const doc = new _xmldom.DOMParser().parseFromString(strEl);

  if (!doc.documentElement.attributes) {
    throw new _baseDriver.errors.UnknownError('the element has no attributes');
  }

  let attrs = Array.from(doc.documentElement.attributes);
  attrs = attrs.reduce((prev, curr) => {
    prev[curr.name] = curr.value;
    return prev;
  }, {});
  return attrs[name];
};

commands.getElementRect = function getElementRect(elementId) {
  const rect = this.getProperty('rect', elementId);

  if (!rect) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError('the element has no rect attribute');
  }

  const mat = /^\[(?<x>\d+),(?<y>\d+),(?<width>\d+),(?<height>\d+)\]$/.exec(rect);

  if (!mat) {
    throw new _baseDriver.errors.InvalidElementCoordinatesError("the element's rect attribute is malformed");
  }

  const {
    x,
    y,
    width,
    height
  } = mat.groups;
  return {
    x: Number.parseInt(x, 10),
    y: Number.parseInt(y, 10),
    width: Number.parseInt(width, 10),
    height: Number.parseInt(height, 10)
  };
};

commands.getSize = function getSize(elementId) {
  const rect = this.getElementRect(elementId);
  return {
    width: rect.width,
    height: rect.height
  };
};

commands.clear = async function clear(elementId) {
  await this.click(elementId);
  await (0, _utils.wait4sec)(0.5);

  _privateapis.default.keyboard_tapKey('a', 4);

  await (0, _utils.wait4sec)(0.1);

  _privateapis.default.keyboard_tapKeyCode(65535, 0);
};

commands.getName = function getName(elementId) {
  const name = this.getProperty('name', elementId);
  return name;
};

commands.getText = function getText(elementId) {
  const text = this.getProperty('text', elementId);
  return text;
};

commands.linuxGetDisplaySize = function linuxGetDisplaySize() {
  return _privateapis.default.c_getMainDisplaySize();
};

commands.linuxMouseMove = function linuxMouseMove(opts = {}) {
  const {
    x,
    y
  } = opts;

  const _x = Number.parseInt(x, 10);

  const _y = Number.parseInt(y, 10);

  if (!_support.util.hasValue(_x) || !_support.util.hasValue(_y)) {
    throw new _baseDriver.errors.UnknownError('parameter x, y are required');
  }

  _privateapis.default.mouse_move(_x, _y);

  return null;
};

commands.linuxMouseSwipe = function linuxMouseSwipe(opts = {}) {
  const {
    sx,
    sy,
    ex,
    ey
  } = opts;

  const _sx = Number.parseInt(sx, 10);

  const _sy = Number.parseInt(sy, 10);

  const _ex = Number.parseInt(ex, 10);

  const _ey = Number.parseInt(ey, 10);

  if (!_support.util.hasValue(_sx) || !_support.util.hasValue(_sy) || !_support.util.hasValue(_ex) || !_support.util.hasValue(_ey)) {
    throw new _baseDriver.errors.UnknownError('parameter sx, sy, ex, ey are required');
  }

  _privateapis.default.mouse_swipe(_sx, _sy, _ex, _ey);

  return null;
};

commands.linuxRightClick = function linuxRightClick(opts = {}) {
  const {
    elementId
  } = opts;

  if (!_support.util.hasValue(elementId)) {
    throw new _baseDriver.errors.UnknownError('parameter elementId is required');
  }

  const rect = this.getElementRect(elementId);
  const x = rect.x + rect.width / 2;
  const y = rect.y + rect.height / 2;

  _privateapis.default.mouse_click(x, y, 3);

  return null;
};

commands.linuxDoubleClick = function linuxDoubleClick(opts = {}) {
  const {
    elementId
  } = opts;

  if (!_support.util.hasValue(elementId)) {
    throw new _baseDriver.errors.UnknownError('parameter elementId is required');
  }

  const rect = this.getElementRect(elementId);
  const x = rect.x + rect.width / 2;
  const y = rect.y + rect.height / 2;

  _privateapis.default.mouse_doubleClick(x, y, 1);

  return null;
};

commands.linuxMouseScroll = function linuxMouseScroll(opts = {}) {
  const {
    moveLeftSteps,
    moveUpSteps
  } = opts;

  let _moveLeftSteps = Number.parseInt(moveLeftSteps, 10);

  let _moveUpSteps = Number.parseInt(moveUpSteps, 10);

  _moveLeftSteps = !_moveLeftSteps ? 0 : _moveLeftSteps;
  _moveUpSteps = !_moveUpSteps ? 0 : _moveUpSteps;

  if (_moveLeftSteps !== 0 || _moveUpSteps !== 0) {
    _privateapis.default.mouse_scroll_x_y(_moveLeftSteps, _moveUpSteps);
  }
};

commands.linuxCopy = function linuxCopy(opts = {}) {
  const {
    str
  } = opts;

  if (!_support.util.hasValue(str)) {
    throw new _baseDriver.errors.UnknownError('parameter str is required');
  }

  _privateapis.default.keyboard_copy(str);
};

commands.linuxGetClipboard = function linuxGetClipboard() {
  return _privateapis.default.keyboard_getClipboardContent();
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZXN0dXJlcy5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIl9maW5kRWxSZWN0IiwidXVpZCIsInN0ckVsIiwiX2NhY2hlIiwiZ2V0IiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiZG9jIiwiZG9tIiwicGFyc2VGcm9tU3RyaW5nIiwiZG9jdW1lbnRFbGVtZW50IiwiYXR0cmlidXRlcyIsIkludmFsaWRFbGVtZW50Q29vcmRpbmF0ZXNFcnJvciIsImF0dHJzIiwiQXJyYXkiLCJmcm9tIiwicmVkdWNlIiwicHJldiIsImN1cnIiLCJuYW1lIiwidmFsdWUiLCJyZWN0IiwibWF0IiwiZXhlYyIsIngiLCJ5Iiwid2lkdGgiLCJoZWlnaHQiLCJncm91cHMiLCJOdW1iZXIiLCJwYXJzZUludCIsInNldFZhbHVlIiwicmVwbGFjZVZhbHVlIiwic2V0VmFsdWVJbW1lZGlhdGUiLCJ2YWx1ZXMiLCJlbGVtZW50SWQiLCJfdiIsIl94IiwiX3kiLCJhcGlzIiwibW91c2VfY2xpY2siLCJrZXlib2FyZF90YXBLZXkiLCJrZXlib2FyZF90YXBLZXlDb2RlIiwia2V5Ym9hcmRfdHlwZVN0cmluZ0NvcHlQYXN0ZSIsImNsaWNrIiwicHJlc3NLZXlDb2RlIiwia2V5Y29kZSIsIm1ldGFzdGF0ZSIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsImxvbmdQcmVzc0tleUNvZGUiLCJpc0tleUNvZGUiLCJrZXlib2FyZF90b2dnbGVLZXlDb2RlIiwia2V5Ym9hcmRfdG9nZ2xlS2V5IiwiZ2V0UHJvcGVydHkiLCJnZXRBdHRyaWJ1dGUiLCJVbmtub3duRXJyb3IiLCJnZXRFbGVtZW50UmVjdCIsImdldFNpemUiLCJjbGVhciIsImdldE5hbWUiLCJnZXRUZXh0IiwidGV4dCIsImxpbnV4R2V0RGlzcGxheVNpemUiLCJjX2dldE1haW5EaXNwbGF5U2l6ZSIsImxpbnV4TW91c2VNb3ZlIiwib3B0cyIsInV0aWwiLCJoYXNWYWx1ZSIsIm1vdXNlX21vdmUiLCJsaW51eE1vdXNlU3dpcGUiLCJzeCIsInN5IiwiZXgiLCJleSIsIl9zeCIsIl9zeSIsIl9leCIsIl9leSIsIm1vdXNlX3N3aXBlIiwibGludXhSaWdodENsaWNrIiwibGludXhEb3VibGVDbGljayIsIm1vdXNlX2RvdWJsZUNsaWNrIiwibGludXhNb3VzZVNjcm9sbCIsIm1vdmVMZWZ0U3RlcHMiLCJtb3ZlVXBTdGVwcyIsIl9tb3ZlTGVmdFN0ZXBzIiwiX21vdmVVcFN0ZXBzIiwibW91c2Vfc2Nyb2xsX3hfeSIsImxpbnV4Q29weSIsInN0ciIsImtleWJvYXJkX2NvcHkiLCJsaW51eEdldENsaXBib2FyZCIsImtleWJvYXJkX2dldENsaXBib2FyZENvbnRlbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsUUFBUSxHQUFHLEVBQWpCOztBQUVBQSxRQUFRLENBQUNDLFdBQVQsR0FBdUIsVUFBVUMsSUFBVixFQUFnQjtBQUNyQyxRQUFNQyxLQUFLLEdBQUcsS0FBS0MsTUFBTCxDQUFZQyxHQUFaLENBQWdCSCxJQUFoQixDQUFkOztBQUNBLE1BQUksQ0FBQ0MsS0FBTCxFQUFZO0FBQ1YsVUFBTSxJQUFJRyxtQkFBT0Msa0JBQVgsQ0FBOEIsMkJBQTlCLENBQU47QUFDRDs7QUFDRCxRQUFNQyxHQUFHLEdBQUcsSUFBSUMsaUJBQUosR0FBVUMsZUFBVixDQUEwQlAsS0FBMUIsQ0FBWjs7QUFDQSxNQUFJLENBQUNLLEdBQUcsQ0FBQ0csZUFBSixDQUFvQkMsVUFBekIsRUFBcUM7QUFDbkMsVUFBTSxJQUFJTixtQkFBT08sOEJBQVgsQ0FBMEMsbUNBQTFDLENBQU47QUFDRDs7QUFDRCxNQUFJQyxLQUFLLEdBQUdDLEtBQUssQ0FBQ0MsSUFBTixDQUFXUixHQUFHLENBQUNHLGVBQUosQ0FBb0JDLFVBQS9CLENBQVo7QUFDQUUsRUFBQUEsS0FBSyxHQUFHQSxLQUFLLENBQUNHLE1BQU4sQ0FBYSxDQUFDQyxJQUFELEVBQU9DLElBQVAs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Q3ZCLFVBQU0sSUFBSXJGLG1CQUFPbUQsWUFBWCxDQUF3QiwyQkFBeEIsQ0FBTjtBQUNEOztBQUNEakIsdUJBQUtvRCxhQUFMLENBQW1CRCxHQUFuQjtBQUNELENBTkQ7O0FBUUEzRixRQUFRLENBQUM2RixpQkFBVCxHQUE2QixTQUFTQSxpQkFBVCxHQUE4QjtBQUN6RCxTQUFPckQscUJBQUtzRCw0QkFBTCxFQUFQO0FBQ0QsQ0FGRDs7ZUFJZTlGLFEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ0BhcHBpdW0vYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgRE9NUGFyc2VyIGFzIGRvbSB9IGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgYXBpcyBmcm9tICdAc3Rkc3BhL3N0ZHNwYWxpbnV4X3RlbXAvZGlzdC9wcml2YXRlYXBpcyc7XG5pbXBvcnQgeyB3YWl0NHNlYyB9IGZyb20gJy4uL3V0aWxzJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuX2ZpbmRFbFJlY3QgPSBmdW5jdGlvbiAodXVpZCkge1xuICBjb25zdCBzdHJFbCA9IHRoaXMuX2NhY2hlLmdldCh1dWlkKTtcbiAgaWYgKCFzdHJFbCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKFwidGhlIGVsZW1lbnQgZG9lc24ndCBleGlzdFwiKTtcbiAgfVxuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHN0ckVsKTtcbiAgaWYgKCFkb2MuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLkludmFsaWRFbGVtZW50Q29vcmRpbmF0ZXNFcnJvcigndGhlIGVsZW1lbnQgaGFzIG5vIHJlY3QgYXR0cmlidXRlJyk7XG4gIH1cbiAgbGV0IGF0dHJzID0gQXJyYXkuZnJvbShkb2MuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMpO1xuICBhdHRycyA9IGF0dHJzLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuICAgIHByZXZbY3Vyci5uYW1lXSA9IGN1cnIudmFsdWU7XG4gICAgcmV0dXJuIHByZXY7XG4gIH0sIHt9KTtcbiAgY29uc3QgcmVjdCA9IGF0dHJzLnJlY3Q7XG4gIGlmICghcmVjdCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEVsZW1lbnRDb29yZGluYXRlc0Vycm9yKCd0aGUgZWxlbWVudCBoYXMgbm8gcmVjdCBhdHRyaWJ1dGUnKTtcbiAgfVxuICBjb25zdCBtYXQgPSAvXlxcWyg/PHg+XFxkKyksKD88eT5cXGQrKSwoPzx3aWR0aD5cXGQrKSwoPzxoZWlnaHQ+XFxkKylcXF0kLy5leGVjKHJlY3QpO1xuICBpZiAoIW1hdCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZEVsZW1lbnRDb29yZGluYXRlc0Vycm9yKFwidGhlIGVsZW1lbnQncyByZWN0IGF0dHJpYnV0ZSBpcyBtYWxmb3JtZWRcIik7XG4gIH1cbiAgY29uc3Qge3gsIHksIHdpZHRoLCBoZWlnaHR9ID0gbWF0Lmdyb3VwcztcbiAgcmV0dXJuIHtcbiAgICB4OiBOdW1iZXIucGFyc2VJbnQoeCwgMTApLFxuICAgIHk6IE51bWJlci5wYXJzZUludCh5LCAxMCksXG4gICAgd2lkdGg6IE51bWJlci5wYXJzZUludCh3aWR0aCwgMTApLFxuICAgIGhlaWdodDogTnVtYmVyLnBhcnNlSW50KGhlaWdodCwgMTApXG4gIH07XG59O1xuXG5jb21tYW5kcy5zZXRWYWx1ZSA9IGNvbW1hbmRzLnJlcGxhY2VWYWx1ZSA9IGNvbW1hbmRzLnNldFZhbHVlSW1tZWRpYXRlID0gYXN5bmMgZnVuY3Rpb24gc2V0VmFsdWUgKHZhbHVlcywgZWxlbWVudElkKSB7XG4gIGNvbnN0IHV1aWQgPSBlbGVtZW50SWQ7XG4gIGNvbnN0IF92ID0gdmFsdWVzWzBdO1xuICBjb25zdCB7eCwgeSwgd2lkdGgsIGhlaWdodH0gPSB0aGlzLl9maW5kRWxSZWN0KHV1aWQpO1xuICBjb25zdCBfeCA9IHggKyB3aWR0aCAvIDI7XG4gIGNvbnN0IF95ID0geSArIGhlaWdodCAvIDI7XG4gIGF3YWl0IHdhaXQ0c2VjKDAuNSk7XG4gIGFwaXMubW91c2VfY2xpY2soX3gsIF95LCAxKTtcbiAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgYXBpcy5rZXlib2FyZF90YXBLZXkoJ2EnLCA0KTsgLy8gY29udHJvbCArIEFcbiAgYXdhaXQgd2FpdDRzZWMoMC4xKTtcbiAgYXBpcy5rZXlib2FyZF90YXBLZXlDb2RlKDY1NTM1LCAwKTsgLy8gZGVsZXRlXG4gIGF3YWl0IHdhaXQ0c2VjKDAuNSk7XG4gIGFwaXMua2V5Ym9hcmRfdHlwZVN0cmluZ0NvcHlQYXN0ZShfdik7XG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMuY2xpY2sgPSBhc3luYyBmdW5jdGlvbiBjbGljayAoZWxlbWVudElkKSB7XG4gIGNvbnN0IHV1aWQgPSBlbGVtZW50SWQ7XG4gIGNvbnN0IHt4LCB5LCB3aWR0aCwgaGVpZ2h0fSA9IHRoaXMuX2ZpbmRFbFJlY3QodXVpZCk7XG4gIGNvbnN0IF94ID0geCArIHdpZHRoIC8gMjtcbiAgY29uc3QgX3kgPSB5ICsgaGVpZ2h0IC8gMjtcbiAgYXdhaXQgd2FpdDRzZWMoMC41KTtcbiAgYXBpcy5tb3VzZV9jbGljayhfeCwgX3ksIDEpO1xuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbW1hbmRzLnByZXNzS2V5Q29kZSA9IGZ1bmN0aW9uIHByZXNzS2V5Q29kZSAoa2V5Y29kZSwgbWV0YXN0YXRlKSB7XG4gIG1ldGFzdGF0ZSB8fCAobWV0YXN0YXRlID0gMCk7XG4gIGlmIChrZXljb2RlID49IDApIHtcbiAgICBhcGlzLmtleWJvYXJkX3RhcEtleUNvZGUoa2V5Y29kZSwgbWV0YXN0YXRlKTtcbiAgfSBlbHNlIHtcbiAgICBhcGlzLmtleWJvYXJkX3RhcEtleShTdHJpbmcuZnJvbUNoYXJDb2RlKC1rZXljb2RlKSwgbWV0YXN0YXRlKTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMubG9uZ1ByZXNzS2V5Q29kZSA9IGFzeW5jIGZ1bmN0aW9uIGxvbmdQcmVzc0tleUNvZGUgKGtleWNvZGUsIG1ldGFzdGF0ZSkge1xuICBtZXRhc3RhdGUgfHwgKG1ldGFzdGF0ZSA9IDApO1xuICBjb25zdCBpc0tleUNvZGUgPSBrZXljb2RlID49IDA7XG4gIGlmIChpc0tleUNvZGUpIHtcbiAgICBhcGlzLmtleWJvYXJkX3RvZ2dsZUtleUNvZGUoa2V5Y29kZSwgdHJ1ZSwgbWV0YXN0YXRlKTtcbiAgICBhd2FpdCB3YWl0NHNlYygwLjUpO1xuICAgIGFwaXMua2V5Ym9hcmRfdG9nZ2xlS2V5Q29kZShrZXljb2RlLCBmYWxzZSwgbWV0YXN0YXRlKTtcbiAgfSBlbHNlIHtcbiAgICBhcGlzLmtleWJvYXJkX3RvZ2dsZUtleShTdHJpbmcuZnJvbUNoYXJDb2RlKC1rZXljb2RlKSwgdHJ1ZSwgbWV0YXN0YXRlKTtcbiAgICBhd2FpdCB3YWl0NHNlYygwLjUpO1xuICAgIGFwaXMua2V5Ym9hcmRfdG9nZ2xlS2V5KFN0cmluZy5mcm9tQ2hhckNvZGUoLWtleWNvZGUpLCBmYWxzZSwgbWV0YXN0YXRlKTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMuZ2V0UHJvcGVydHkgPSBjb21tYW5kcy5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbiBnZXRQcm9wZXJ0eSAobmFtZSwgZWxlbWVudElkKSB7XG4gIGNvbnN0IHN0ckVsID0gdGhpcy5fY2FjaGUuZ2V0KGVsZW1lbnRJZCk7XG4gIGlmICghc3RyRWwpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcihcInRoZSBlbGVtZW50IGRvZXNuJ3QgZXhpc3RcIik7XG4gIH1cbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyhzdHJFbCk7XG4gIGlmICghZG9jLmRvY3VtZW50RWxlbWVudC5hdHRyaWJ1dGVzKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoJ3RoZSBlbGVtZW50IGhhcyBubyBhdHRyaWJ1dGVzJyk7XG4gIH1cbiAgbGV0IGF0dHJzID0gQXJyYXkuZnJvbShkb2MuZG9jdW1lbnRFbGVtZW50LmF0dHJpYnV0ZXMpO1xuICBhdHRycyA9IGF0dHJzLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuICAgIHByZXZbY3Vyci5uYW1lXSA9IGN1cnIudmFsdWU7XG4gICAgcmV0dXJuIHByZXY7XG4gIH0sIHt9KTtcbiAgcmV0dXJuIGF0dHJzW25hbWVdO1xufTtcblxuY29tbWFuZHMuZ2V0RWxlbWVudFJlY3QgPSBmdW5jdGlvbiBnZXRFbGVtZW50UmVjdCAoZWxlbWVudElkKSB7XG4gIGNvbnN0IHJlY3QgPSB0aGlzLmdldFByb3BlcnR5KCdyZWN0JywgZWxlbWVudElkKTtcbiAgaWYgKCFyZWN0KSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkRWxlbWVudENvb3JkaW5hdGVzRXJyb3IoJ3RoZSBlbGVtZW50IGhhcyBubyByZWN0IGF0dHJpYnV0ZScpO1xuICB9XG4gIGNvbnN0IG1hdCA9IC9eXFxbKD88eD5cXGQrKSwoPzx5PlxcZCspLCg/PHdpZHRoPlxcZCspLCg/PGhlaWdodD5cXGQrKVxcXSQvLmV4ZWMocmVjdCk7XG4gIGlmICghbWF0KSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkRWxlbWVudENvb3JkaW5hdGVzRXJyb3IoXCJ0aGUgZWxlbWVudCdzIHJlY3QgYXR0cmlidXRlIGlzIG1hbGZvcm1lZFwiKTtcbiAgfVxuICBjb25zdCB7eCwgeSwgd2lkdGgsIGhlaWdodH0gPSBtYXQuZ3JvdXBzO1xuICByZXR1cm4ge1xuICAgIHg6IE51bWJlci5wYXJzZUludCh4LCAxMCksXG4gICAgeTogTnVtYmVyLnBhcnNlSW50KHksIDEwKSxcbiAgICB3aWR0aDogTnVtYmVyLnBhcnNlSW50KHdpZHRoLCAxMCksXG4gICAgaGVpZ2h0OiBOdW1iZXIucGFyc2VJbnQoaGVpZ2h0LCAxMClcbiAgfTtcbn07XG5cbmNvbW1hbmRzLmdldFNpemUgPSBmdW5jdGlvbiBnZXRTaXplIChlbGVtZW50SWQpIHtcbiAgY29uc3QgcmVjdCA9IHRoaXMuZ2V0RWxlbWVudFJlY3QoZWxlbWVudElkKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aDogcmVjdC53aWR0aCxcbiAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0XG4gIH07XG59O1xuXG5jb21tYW5kcy5jbGVhciA9IGFzeW5jIGZ1bmN0aW9uIGNsZWFyIChlbGVtZW50SWQpIHtcbiAgYXdhaXQgdGhpcy5jbGljayhlbGVtZW50SWQpO1xuICBhd2FpdCB3YWl0NHNlYygwLjUpO1xuICBhcGlzLmtleWJvYXJkX3RhcEtleSgnYScsIDQpOyAvLyBjb250cm9sICsgQVxuICBhd2FpdCB3YWl0NHNlYygwLjEpO1xuICBhcGlzLmtleWJvYXJkX3RhcEtleUNvZGUoNjU1MzUsIDApOyAvLyBkZWxldGVcbn07XG5cbmNvbW1hbmRzLmdldE5hbWUgPSBmdW5jdGlvbiBnZXROYW1lIChlbGVtZW50SWQpIHtcbiAgY29uc3QgbmFtZSA9IHRoaXMuZ2V0UHJvcGVydHkoJ25hbWUnLCBlbGVtZW50SWQpO1xuICByZXR1cm4gbmFtZTtcbn07XG5cbmNvbW1hbmRzLmdldFRleHQgPSBmdW5jdGlvbiBnZXRUZXh0IChlbGVtZW50SWQpIHtcbiAgY29uc3QgdGV4dCA9IHRoaXMuZ2V0UHJvcGVydHkoJ3RleHQnLCBlbGVtZW50SWQpO1xuICByZXR1cm4gdGV4dDtcbn07XG5cbmNvbW1hbmRzLmxpbnV4R2V0RGlzcGxheVNpemUgPSBmdW5jdGlvbiBsaW51eEdldERpc3BsYXlTaXplICgpIHtcbiAgcmV0dXJuIGFwaXMuY19nZXRNYWluRGlzcGxheVNpemUoKTtcbn07XG5cbmNvbW1hbmRzLmxpbnV4TW91c2VNb3ZlID0gZnVuY3Rpb24gbGludXhNb3VzZU1vdmUgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7eCwgeX0gPSBvcHRzO1xuICBjb25zdCBfeCA9IE51bWJlci5wYXJzZUludCh4LCAxMCk7XG4gIGNvbnN0IF95ID0gTnVtYmVyLnBhcnNlSW50KHksIDEwKTtcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKF94KSB8fCAhdXRpbC5oYXNWYWx1ZShfeSkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcigncGFyYW1ldGVyIHgsIHkgYXJlIHJlcXVpcmVkJyk7XG4gIH1cbiAgYXBpcy5tb3VzZV9tb3ZlKF94LCBfeSk7XG4gIHJldHVybiBudWxsO1xufTtcblxuY29tbWFuZHMubGludXhNb3VzZVN3aXBlID0gZnVuY3Rpb24gbGludXhNb3VzZVN3aXBlIChvcHRzID0ge30pIHtcbiAgY29uc3Qge3N4LCBzeSwgZXgsIGV5fSA9IG9wdHM7XG4gIGNvbnN0IF9zeCA9IE51bWJlci5wYXJzZUludChzeCwgMTApO1xuICBjb25zdCBfc3kgPSBOdW1iZXIucGFyc2VJbnQoc3ksIDEwKTtcbiAgY29uc3QgX2V4ID0gTnVtYmVyLnBhcnNlSW50KGV4LCAxMCk7XG4gIGNvbnN0IF9leSA9IE51bWJlci5wYXJzZUludChleSwgMTApO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUoX3N4KSB8fCAhdXRpbC5oYXNWYWx1ZShfc3kpIHx8ICF1dGlsLmhhc1ZhbHVlKF9leCkgfHwgIXV0aWwuaGFzVmFsdWUoX2V5KSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKCdwYXJhbWV0ZXIgc3gsIHN5LCBleCwgZXkgYXJlIHJlcXVpcmVkJyk7XG4gIH1cbiAgYXBpcy5tb3VzZV9zd2lwZShfc3gsIF9zeSwgX2V4LCBfZXkpO1xuICByZXR1cm4gbnVsbDtcbn07XG5cbmNvbW1hbmRzLmxpbnV4UmlnaHRDbGljayA9IGZ1bmN0aW9uIGxpbnV4UmlnaHRDbGljayAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtlbGVtZW50SWR9ID0gb3B0cztcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKGVsZW1lbnRJZCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcigncGFyYW1ldGVyIGVsZW1lbnRJZCBpcyByZXF1aXJlZCcpO1xuICB9XG4gIGNvbnN0IHJlY3QgPSB0aGlzLmdldEVsZW1lbnRSZWN0KGVsZW1lbnRJZCk7XG4gIGNvbnN0IHggPSByZWN0LnggKyByZWN0LndpZHRoIC8gMjtcbiAgY29uc3QgeSA9IHJlY3QueSArIHJlY3QuaGVpZ2h0IC8gMjtcbiAgYXBpcy5tb3VzZV9jbGljayh4LCB5LCAzKTtcbiAgcmV0dXJuIG51bGw7XG59O1xuXG5jb21tYW5kcy5saW51eERvdWJsZUNsaWNrID0gZnVuY3Rpb24gbGludXhEb3VibGVDbGljayAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtlbGVtZW50SWR9ID0gb3B0cztcbiAgaWYgKCF1dGlsLmhhc1ZhbHVlKGVsZW1lbnRJZCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcigncGFyYW1ldGVyIGVsZW1lbnRJZCBpcyByZXF1aXJlZCcpO1xuICB9XG4gIGNvbnN0IHJlY3QgPSB0aGlzLmdldEVsZW1lbnRSZWN0KGVsZW1lbnRJZCk7XG4gIGNvbnN0IHggPSByZWN0LnggKyByZWN0LndpZHRoIC8gMjtcbiAgY29uc3QgeSA9IHJlY3QueSArIHJlY3QuaGVpZ2h0IC8gMjtcbiAgYXBpcy5tb3VzZV9kb3VibGVDbGljayh4LCB5LCAxKTtcbiAgcmV0dXJuIG51bGw7XG59O1xuXG5jb21tYW5kcy5saW51eE1vdXNlU2Nyb2xsID0gZnVuY3Rpb24gbGludXhNb3VzZVNjcm9sbCAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHttb3ZlTGVmdFN0ZXBzLCBtb3ZlVXBTdGVwc30gPSBvcHRzO1xuICBsZXQgX21vdmVMZWZ0U3RlcHMgPSBOdW1iZXIucGFyc2VJbnQobW92ZUxlZnRTdGVwcywgMTApO1xuICBsZXQgX21vdmVVcFN0ZXBzID0gTnVtYmVyLnBhcnNlSW50KG1vdmVVcFN0ZXBzLCAxMCk7XG4gIF9tb3ZlTGVmdFN0ZXBzID0gIV9tb3ZlTGVmdFN0ZXBzID8gMCA6IF9tb3ZlTGVmdFN0ZXBzO1xuICBfbW92ZVVwU3RlcHMgPSAhX21vdmVVcFN0ZXBzID8gMCA6IF9tb3ZlVXBTdGVwcztcbiAgaWYgKF9tb3ZlTGVmdFN0ZXBzICE9PSAwIHx8IF9tb3ZlVXBTdGVwcyAhPT0gMCkge1xuICAgIGFwaXMubW91c2Vfc2Nyb2xsX3hfeShfbW92ZUxlZnRTdGVwcywgX21vdmVVcFN0ZXBzKTtcbiAgfVxufTtcblxuY29tbWFuZHMubGludXhDb3B5ID0gZnVuY3Rpb24gbGludXhDb3B5IChvcHRzID0ge30pIHtcbiAgY29uc3Qge3N0cn0gPSBvcHRzO1xuICBpZiAoIXV0aWwuaGFzVmFsdWUoc3RyKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKCdwYXJhbWV0ZXIgc3RyIGlzIHJlcXVpcmVkJyk7XG4gIH1cbiAgYXBpcy5rZXlib2FyZF9jb3B5KHN0cik7XG59O1xuXG5jb21tYW5kcy5saW51eEdldENsaXBib2FyZCA9IGZ1bmN0aW9uIGxpbnV4R2V0Q2xpcGJvYXJkICgpIHtcbiAgcmV0dXJuIGFwaXMua2V5Ym9hcmRfZ2V0Q2xpcGJvYXJkQ29udGVudCgpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZXN0dXJlcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
