"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _privateapis = _interopRequireDefault(require("@stdspa/stdspalinux_temp/dist/privateapis"));

var _logger = _interopRequireDefault(require("../logger"));

var _xpath = _interopRequireDefault(require("xpath.js"));

var _xmldom = require("xmldom");

var _baseDriver = require("@appium/base-driver");

const commands = {};

commands.getWindowHandle = function getWindowHandle() {
  var _this$_win;

  return (_this$_win = this._win) === null || _this$_win === void 0 ? void 0 : _this$_win.wid;
};

commands.getWindowHandles = function getWindowHandles() {
  const appName = this.appName;

  const pids = _privateapis.default.app_running(appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[${xpath} and @InputOutput="true"]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    return [];
  }

  let _nodes = [];

  for (const node of nodes) {
    if (!node.attributes) {
      continue;
    }

    const _node = {};
    const attrs = Array.from(node.attributes);

    for (const attr of attrs) {
      if (attr.name == "class") {
        _node.class = attr.value.split(' ');
      } else if (attr.name == "name") {
        _node.name = attr.value;
      } else if (attr.name == "pid") {
        _node.pid = Number.parseInt(attr.value);
      } else if (attr.name == "wid") {
        _node.wid = Number.parseInt(attr.value);
      }
    }

    _nodes.push(_node);
  }

  _nodes = _nodes.filter(p => (p.class || p.name) && p.pid && p.wid);

  if (_nodes.length === 0) {
    return [];
  }

  _nodes = _nodes.map(p => {
    let _node = {
      pid: p.pid,
      wid: p.wid,
      names: []
    };

    if (p.name) {
      _node.names.push(p.name);
    }

    if (p.class) {
      _node.names.push(...p.class);
    }

    return _node;
  });
  const wids = [];

  for (const _node of _nodes) {
    let ok = false;

    for (const name of _node.names) {
      if (_privateapis.default.a11y_checkWindowExists(name, _node.pid)) {
        ok = true;
        break;
      }
    }

    if (ok) {
      wids.push(_node.wid);
    }
  }

  return wids;
};

commands._getWinAndPid_FromWinName = function (windowName) {
  const pids = _privateapis.default.app_running(this.appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${this.appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[(${xpath}) and @InputOutput="true" and (@name="${windowName}" or contains(concat(" ", @class, " "), "${" " + windowName + " "}"))]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  let _nodes = [];

  for (const node of nodes) {
    if (!node.attributes) {
      continue;
    }

    const attrs = Array.from(node.attributes);
    const _node = {};

    for (const attr of attrs) {
      _node[attr.name] = attr.value;
    }

    _nodes.push(_node);
  }

  _nodes = _nodes.filter(p => (p.name || p.class) && p.pid && p.wid);

  if (_nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  _nodes.sort((a, b) => {
    const av = a.name == windowName ? -1 : 1;
    const bv = b.name == windowName ? -1 : 1;
    return av - bv;
  });

  for (const _node of _nodes) {
    const _pid = Number.parseInt(_node.pid);

    if (_privateapis.default.a11y_checkWindowExists(windowName, _pid)) {
      return {
        pid: _pid,
        wid: Number.parseInt(_node.wid),
        name: windowName
      };
    }
  }

  throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
};

commands._getWinAndPid_FromWinId = function (wid) {
  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  const xpath = `//*[@wid="${wid}" and @InputOutput="true"]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  let node = nodes[0];
  const attrs = Array.from(node.attributes);
  const _node = {};

  for (const attr of attrs) {
    _node[attr.name] = attr.value;
  }

  node = _node;

  if (!node.name || !node.pid || !node.wid) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  if (!_privateapis.default.a11y_checkWindowExists(node.name, Number.parseInt(node.pid))) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  return {
    pid: Number.parseInt(node.pid),
    wid: Number.parseInt(node.wid),
    name: node.name
  };
};

function validateName(name) {
  if (!name) {
    return name;
  }

  for (let i = 0; i < name.length; ++i) {
    if (name[i] < '0' || name[i] > '9') {
      return name;
    }
  }

  return null;
}

function validateHandle(handle) {
  if (!handle) {
    return handle;
  }

  for (let i = 0; i < handle.length; ++i) {
    if (handle[i] < '0' || handle[i] > '9') {
      return null;
    }
  }

  return handle;
}

commands.setWindow = function setWindow(name, handle) {
  handle = validateHandle(handle);
  name = validateName(name);

  if (name) {
    const win = this._getWinAndPid_FromWinName(name);

    this._win = win;
  } else if (handle) {
    const win = this._getWinAndPid_FromWinId(handle);

    this._win = win;
  } else {
    throw new _baseDriver.errors.UnknownError("setWindow both name and handle don't have a value");
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93aW5kb3cuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJnZXRXaW5kb3dIYW5kbGUiLCJfd2luIiwid2lkIiwiZ2V0V2luZG93SGFuZGxlcyIsImFwcE5hbWUiLCJwaWRzIiwiYXBpcyIsImFwcF9ydW5uaW5nIiwibGVuZ3RoIiwiZXJyb3JzIiwiTm9TdWNoV2luZG93RXJyb3IiLCJ3aW5IaWVyYWNoeSIsImFwcF9nZXRXaW5kb3dIaWVyYWNoeSIsImRvYyIsImRvbSIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwibWFwIiwicGlkIiwiam9pbiIsIm5vZGVzIiwiX25vZGVzIiwibm9kZSIsImF0dHJpYnV0ZXMiLCJfbm9kZSIsImF0dHJzIiwiQXJyYXkiLCJmcm9tIiwiYXR0ciIsIm5hbWUiLCJjbGFzcyIsInZhbHVlIiwic3BsaXQiLCJOdW1iZXIiLCJwYXJzZUludCIsInB1c2giLCJmaWx0ZXIiLCJwIiwibmFtZXMiLCJ3aWRzIiwib2siLCJhMTF5X2NoZWNrV2luZG93RXhpc3RzIiwiX2dldFdpbkFuZFBpZF9Gcm9tV2luTmFtZSIsIndpbmRvd05hbWUiLCJzb3J0IiwiYSIsImIiLCJhdiIsImJ2IiwiX3BpZCIsIl9nZXRXaW5BbmRQaWRfRnJvbVdpbklkIiwidmFsaWRhdGVOYW1lIiwiaSIsInZhbGlkYXRlSGFuZGxlIiwiaGFuZGxlIiwic2V0V2luZG93Iiwid2luIiwiVW5rbm93bkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjs7QUFFQUEsUUFBUSxDQUFDQyxlQUFULEdBQTJCLFNBQVNBLGVBQVQsR0FBNEI7QUFBQTs7QUFDckQsdUJBQU8sS0FBS0MsSUFBWiwrQ0FBTyxXQUFXQyxHQUFsQjtBQUNELENBRkQ7O0FBSUFILFFBQVEsQ0FBQ0ksZ0JBQVQsR0FBNEIsU0FBU0EsZ0JBQVQsR0FBNkI7QUFDdkQsUUFB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U0FBVCxHQUFxQixTQUFTQSxTQUFULENBQW9CMUIsSUFBcEIsRUFBMEJ5QixNQUExQixFQUFrQztBQUNyREEsRUFBQUEsTUFBTSxHQUFHRCxjQUFjLENBQUNDLE1BQUQsQ0FBdkI7QUFDQXpCLEVBQUFBLElBQUksR0FBR3NCLFlBQVksQ0FBQ3RCLElBQUQsQ0FBbkI7O0FBQ0EsTUFBSUEsSUFBSixFQUFVO0FBQ1IsVUFBTTJCLEdBQUcsR0FBRyxLQUFLZCx5QkFBTCxDQUErQmIsSUFBL0IsQ0FBWjs7QUFDQSxTQUFLNUIsSUFBTCxHQUFZdUQsR0FBWjtBQUNELEdBSEQsTUFHTyxJQUFJRixNQUFKLEVBQVk7QUFDakIsVUFBTUUsR0FBRyxHQUFHLEtBQUtOLHVCQUFMLENBQTZCSSxNQUE3QixDQUFaOztBQUNBLFNBQUtyRCxJQUFMLEdBQVl1RCxHQUFaO0FBQ0QsR0FITSxNQUdBO0FBQ0wsVUFBTSxJQUFJL0MsbUJBQU9nRCxZQUFYLENBQXdCLG1EQUF4QixDQUFOO0FBQ0Q7QUFDRixDQVpEOztlQWNlMUQsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhcGlzIGZyb20gJ0BzdGRzcGEvc3Rkc3BhbGludXhfdGVtcC9kaXN0L3ByaXZhdGVhcGlzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBzZWxlY3QgZnJvbSAneHBhdGguanMnO1xuaW1wb3J0IHsgRE9NUGFyc2VyIGFzIGRvbSB9IGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdAYXBwaXVtL2Jhc2UtZHJpdmVyJztcblxuY29uc3QgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlID0gZnVuY3Rpb24gZ2V0V2luZG93SGFuZGxlICgpIHtcbiAgcmV0dXJuIHRoaXMuX3dpbj8ud2lkO1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlcyA9IGZ1bmN0aW9uIGdldFdpbmRvd0hhbmRsZXMgKCkge1xuICBjb25zdCBhcHBOYW1lID0gdGhpcy5hcHBOYW1lO1xuICBjb25zdCBwaWRzID0gYXBpcy5hcHBfcnVubmluZyhhcHBOYW1lKTtcbiAgaWYgKCFwaWRzIHx8IHBpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgYXBwbGljYXRpb24gJHthcHBOYW1lfSBpcyBub3QgcnVubmluZ2ApO1xuICB9XG4gIGNvbnN0IHdpbkhpZXJhY2h5ID0gYXBpcy5hcHBfZ2V0V2luZG93SGllcmFjaHkoKTtcbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyh3aW5IaWVyYWNoeSk7XG4gIGxldCB4cGF0aCA9IHBpZHMubWFwKHBpZCA9PiBgQHBpZD1cIiR7cGlkfVwiYCkuam9pbihcIiBvciBcIik7XG4gIHhwYXRoID0gYC8vKlske3hwYXRofSBhbmQgQElucHV0T3V0cHV0PVwidHJ1ZVwiXWA7XG4gIGNvbnN0IG5vZGVzID0gc2VsZWN0KGRvYywgeHBhdGgpO1xuICBpZiAoIW5vZGVzIHx8IG5vZGVzLmxlbmd0aCA9PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIGxldCBfbm9kZXMgPSBbXTtcbiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgaWYgKCFub2RlLmF0dHJpYnV0ZXMpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBjb25zdCBfbm9kZSA9IHt9O1xuICAgIGNvbnN0IGF0dHJzID0gQXJyYXkuZnJvbShub2RlLmF0dHJpYnV0ZXMpO1xuICAgIGZvciAoY29uc3QgYXR0ciBvZiBhdHRycykge1xuICAgICAgaWYgKGF0dHIubmFtZSA9PSBcImNsYXNzXCIpIHtcbiAgICAgICAgX25vZGUuY2xhc3MgPSBhdHRyLnZhbHVlLnNwbGl0KCcgJyk7XG4gICAgICB9IGVsc2UgaWYgKGF0dHIubmFtZSA9PSBcIm5hbWVcIikge1xuICAgICAgICBfbm9kZS5uYW1lID0gYXR0ci52YWx1ZTtcbiAgICAgIH0gZWxzZSBpZiAoYXR0ci5uYW1lID09IFwicGlkXCIpIHtcbiAgICAgICAgX25vZGUucGlkID0gTnVtYmVyLnBhcnNlSW50KGF0dHIudmFsdWUpO1xuICAgICAgfSBlbHNlIGlmIChhdHRyLm5hbWUgPT0gXCJ3aWRcIikge1xuICAgICAgICBfbm9kZS53aWQgPSBOdW1iZXIucGFyc2VJbnQoYXR0ci52YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIF9ub2Rlcy5wdXNoKF9ub2RlKTtcbiAgfVxuICBfbm9kZXMgPSBfbm9kZXMuZmlsdGVyKHAgPT4gKHAuY2xhc3MgfHwgcC5uYW1lKSAmJiBwLnBpZCAmJiBwLndpZCk7XG4gIGlmIChfbm9kZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIF9ub2RlcyA9IF9ub2Rlcy5tYXAocCA9PiB7XG4gICAgbGV0IF9ub2RlID0ge3BpZDogcC5waWQsIHdpZDogcC53aWQsIG5hbWVzOiBbXX07XG4gICAgaWYgKHAubmFtZSkge1xuICAgICAgX25vZGUubmFtZXMucHVzaChwLm5hbWUpO1xuICAgIH1cbiAgICBpZiAocC5jbGFzcykge1xuICAgICAgX25vZGUubmFtZXMucHVzaCguLi5wLmNsYXNzKTtcbiAgICB9XG4gICAgcmV0dXJuIF9ub2RlO1xuICB9KTtcbiAgY29uc3Qgd2lkcyA9IFtdO1xuICBmb3IgKGNvbnN0IF9ub2RlIG9mIF9ub2Rlcykge1xuICAgIGxldCBvayA9IGZhbHNlO1xuICAgIGZvciAoY29uc3QgbmFtZSBvZiBfbm9kZS5uYW1lcykge1xuICAgICAgaWYgKGFwaXMuYTExeV9jaGVja1dpbmRvd0V4aXN0cyhuYW1lLCBfbm9kZS5waWQpKSB7XG4gICAgICAgIG9rID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChvaykge1xuICAgICAgd2lkcy5wdXNoKF9ub2RlLndpZCk7XG4gICAgfVxuICB9XG4gIHJldHVybiB3aWRzO1xufVxuXG5jb21tYW5kcy5fZ2V0V2luQW5kUGlkX0Zyb21XaW5OYW1lID0gZnVuY3Rpb24gKHdpbmRvd05hbWUpIHtcbiAgY29uc3QgcGlkcyA9IGFwaXMuYXBwX3J1bm5pbmcodGhpcy5hcHBOYW1lKTtcbiAgaWYgKCFwaWRzIHx8IHBpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgYXBwbGljYXRpb24gJHt0aGlzLmFwcE5hbWV9IGlzIG5vdCBydW5uaW5nYCk7XG4gIH1cbiAgY29uc3Qgd2luSGllcmFjaHkgPSBhcGlzLmFwcF9nZXRXaW5kb3dIaWVyYWNoeSgpO1xuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHdpbkhpZXJhY2h5KTtcbiAgbGV0IHhwYXRoID0gcGlkcy5tYXAocGlkID0+IGBAcGlkPVwiJHtwaWR9XCJgKS5qb2luKFwiIG9yIFwiKTtcbiAgeHBhdGggPSBgLy8qWygke3hwYXRofSkgYW5kIEBJbnB1dE91dHB1dD1cInRydWVcIiBhbmQgKEBuYW1lPVwiJHt3aW5kb3dOYW1lfVwiIG9yIGNvbnRhaW5zKGNvbmNhdChcIiBcIiwgQGNsYXNzLCBcIiBcIiksIFwiJHtcIiBcIiArIHdpbmRvd05hbWUgKyBcIiBcIn1cIikpXWA7XG4gIGNvbnN0IG5vZGVzID0gc2VsZWN0KGRvYywgeHBhdGgpO1xuICBpZiAoIW5vZGVzIHx8IG5vZGVzLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyAke3dpbmRvd05hbWV9IGRvZXNuJ3QgcHJlc2VudGApO1xuICB9XG4gIGxldCBfbm9kZXMgPSBbXTtcbiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgaWYgKCFub2RlLmF0dHJpYnV0ZXMpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBjb25zdCBhdHRycyA9IEFycmF5LmZyb20obm9kZS5hdHRyaWJ1dGVzKTtcbiAgICBjb25zdCBfbm9kZSA9IHt9O1xuICAgIGZvciAoY29uc3QgYXR0ciBvZiBhdHRycykge1xuICAgICAgX25vZGVbYXR0ci5uYW1lXSA9IGF0dHIudmFsdWU7XG4gICAgfVxuICAgIF9ub2Rlcy5wdXNoKF9ub2RlKTtcbiAgfVxuICBfbm9kZXMgPSBfbm9kZXMuZmlsdGVyKHAgPT4gKHAubmFtZSB8fCBwLmNsYXNzKSAmJiBwLnBpZCAmJiBwLndpZCk7XG4gIGlmIChfbm9kZXMubGVuZ3RoID09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93ICR7d2luZG93TmFtZX0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgX25vZGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICBjb25zdCBhdiA9IGEubmFtZSA9PSB3aW5kb3dOYW1lPyAtMTogMTtcbiAgICBjb25zdCBidiA9IGIubmFtZSA9PSB3aW5kb3dOYW1lPyAtMTogMTtcbiAgICByZXR1cm4gYXYgLSBidjtcbiAgfSk7XG4gIGZvciAoY29uc3QgX25vZGUgb2YgX25vZGVzKSB7XG4gICAgY29uc3QgX3BpZCA9IE51bWJlci5wYXJzZUludChfbm9kZS5waWQpO1xuICAgIGlmIChhcGlzLmExMXlfY2hlY2tXaW5kb3dFeGlzdHMod2luZG93TmFtZSwgX3BpZCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBpZDogX3BpZCxcbiAgICAgICAgd2lkOiBOdW1iZXIucGFyc2VJbnQoX25vZGUud2lkKSxcbiAgICAgICAgbmFtZTogd2luZG93TmFtZVxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyAke3dpbmRvd05hbWV9IGRvZXNuJ3QgcHJlc2VudGApO1xufVxuXG5jb21tYW5kcy5fZ2V0V2luQW5kUGlkX0Zyb21XaW5JZCA9IGZ1bmN0aW9uICh3aWQpIHtcbiAgY29uc3Qgd2luSGllcmFjaHkgPSBhcGlzLmFwcF9nZXRXaW5kb3dIaWVyYWNoeSgpO1xuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHdpbkhpZXJhY2h5KTtcbiAgY29uc3QgeHBhdGggPSBgLy8qW0B3aWQ9XCIke3dpZH1cIiBhbmQgQElucHV0T3V0cHV0PVwidHJ1ZVwiXWA7XG4gIGNvbnN0IG5vZGVzID0gc2VsZWN0KGRvYywgeHBhdGgpO1xuICBpZiAoIW5vZGVzIHx8IG5vZGVzLmxlbmd0aCA9PSAwKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyB3aWQ9JHt3aWR9IGRvZXNuJ3QgcHJlc2VudGApO1xuICB9XG4gIGxldCBub2RlID0gbm9kZXNbMF07XG4gIGNvbnN0IGF0dHJzID0gQXJyYXkuZnJvbShub2RlLmF0dHJpYnV0ZXMpO1xuICBjb25zdCBfbm9kZSA9IHt9O1xuICBmb3IgKGNvbnN0IGF0dHIgb2YgYXR0cnMpIHtcbiAgICBfbm9kZVthdHRyLm5hbWVdID0gYXR0ci52YWx1ZTtcbiAgfVxuICBub2RlID0gX25vZGU7XG4gIGlmICghbm9kZS5uYW1lIHx8ICFub2RlLnBpZCB8fCAhbm9kZS53aWQpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93IHdpZD0ke3dpZH0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgaWYgKCFhcGlzLmExMXlfY2hlY2tXaW5kb3dFeGlzdHMobm9kZS5uYW1lLCBOdW1iZXIucGFyc2VJbnQobm9kZS5waWQpKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgd2lkPSR7d2lkfSBkb2Vzbid0IHByZXNlbnRgKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHBpZDogTnVtYmVyLnBhcnNlSW50KG5vZGUucGlkKSxcbiAgICB3aWQ6IE51bWJlci5wYXJzZUludChub2RlLndpZCksXG4gICAgbmFtZTogbm9kZS5uYW1lXG4gIH07XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlTmFtZShuYW1lKSB7XG4gIGlmICghbmFtZSkge1xuICAgIHJldHVybiBuYW1lO1xuICB9XG4gIGZvcihsZXQgaT0wOyBpPG5hbWUubGVuZ3RoOyArK2kpIHtcbiAgICBpZiAobmFtZVtpXSA8ICcwJyB8fCBuYW1lW2ldID4gJzknKSB7XG4gICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlSGFuZGxlKGhhbmRsZSkge1xuICBpZiAoIWhhbmRsZSkge1xuICAgIHJldHVybiBoYW5kbGU7XG4gIH1cbiAgZm9yKGxldCBpPTA7IGk8aGFuZGxlLmxlbmd0aDsgKytpKSB7XG4gICAgaWYgKGhhbmRsZVtpXSA8ICcwJyB8fCBoYW5kbGVbaV0gPiAnOScpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuICByZXR1cm4gaGFuZGxlO1xufVxuXG5jb21tYW5kcy5zZXRXaW5kb3cgPSBmdW5jdGlvbiBzZXRXaW5kb3cgKG5hbWUsIGhhbmRsZSkge1xuICBoYW5kbGUgPSB2YWxpZGF0ZUhhbmRsZShoYW5kbGUpO1xuICBuYW1lID0gdmFsaWRhdGVOYW1lKG5hbWUpO1xuICBpZiAobmFtZSkge1xuICAgIGNvbnN0IHdpbiA9IHRoaXMuX2dldFdpbkFuZFBpZF9Gcm9tV2luTmFtZShuYW1lKTtcbiAgICB0aGlzLl93aW4gPSB3aW47XG4gIH0gZWxzZSBpZiAoaGFuZGxlKSB7XG4gICAgY29uc3Qgd2luID0gdGhpcy5fZ2V0V2luQW5kUGlkX0Zyb21XaW5JZChoYW5kbGUpO1xuICAgIHRoaXMuX3dpbiA9IHdpbjtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihcInNldFdpbmRvdyBib3RoIG5hbWUgYW5kIGhhbmRsZSBkb24ndCBoYXZlIGEgdmFsdWVcIik7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7Il0sImZpbGUiOiJsaWIvY29tbWFuZHMvd2luZG93LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
