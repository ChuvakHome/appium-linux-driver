"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _privateapis = _interopRequireDefault(require("@stdspa/stdspalinux_temp/dist/privateapis"));

var _logger = _interopRequireDefault(require("../logger"));

var _xpath = _interopRequireDefault(require("xpath.js"));

var _xmldom = require("xmldom");

var _baseDriver = require("@appium/base-driver");

const commands = {};

commands.getWindowHandle = async function getWindowHandle() {
  var _this$_win;

  return (_this$_win = this._win) === null || _this$_win === void 0 ? void 0 : _this$_win.wid;
};

commands.getWindowHandles = async function getWindowHandles() {
  const appName = this.appName;

  const pids = _privateapis.default.app_running(appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[${xpath}]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    return [];
  }

  const wids = [];

  for (const node of nodes) {
    const attrs = node.attributes;

    for (const attr of attrs) {
      if (attr.name == "wid") {
        wids.push(Number.parseInt(attr.value));
      }
    }
  }

  return wids;
};

commands._getWinAndPid_FromWinName = function (windowName) {
  const pids = _privateapis.default.app_running(appName);

  if (!pids || pids.length === 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`application ${this.appName} is not running`);
  }

  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  let xpath = pids.map(pid => `@pid="${pid}"`).join(" or ");
  xpath = `//*[(${xpath}) and (@name="${windowName}" or contains(concat(" ", @class, " "), "${" " + windowName + " "}"))]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  let _nodes = [];

  for (const node of nodes) {
    const attrs = node.attributes;
    const _node = {};

    for (const attr of attrs) {
      _node[attr.name] = attr.value;
    }

    _nodes.push(_node);
  }

  _nodes = _nodes.filter(p => (p.name || p.class) && p.pid && p.wid);

  if (_nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
  }

  _nodes.sort((a, b) => {
    const av = a.name == windowName ? -1 : 1;
    const bv = b.name == windowName ? -1 : 1;
    return av - bv;
  });

  for (const _node of _nodes) {
    const _pid = Number.parseInt(_node.pid);

    if (_privateapis.default.a11y_checkWindowExists(windowName, _pid)) {
      return {
        pid: _pid,
        wid: Number.parseInt(_node.wid),
        name: windowName
      };
    }
  }

  throw new _baseDriver.errors.NoSuchWindowError(`the window ${windowName} doesn't present`);
};

commands._getWinAndPid_FromWinId = function (wid) {
  const winHierachy = _privateapis.default.app_getWindowHierachy();

  const doc = new _xmldom.DOMParser().parseFromString(winHierachy);
  const xpath = `//*[@wid="${wid}"]`;
  const nodes = (0, _xpath.default)(doc, xpath);

  if (!nodes || nodes.length == 0) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  const node = nodes[0];

  if (!node.name || !node.pid || !node.wid) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  if (!_privateapis.default.a11y_checkWindowExists(node.name, Number.parseInt(node.pid))) {
    throw new _baseDriver.errors.NoSuchWindowError(`the window wid=${wid} doesn't present`);
  }

  return {
    pid: Number.parseInt(node.pid),
    wid: Number.parseInt(node.wid),
    name: node.name
  };
};

commands.setWindow = function setWindow(opts = {}) {
  const {
    name,
    handle
  } = opts;

  if (name) {
    const win = this._getWinAndPid_FromWinName(name);

    this._win = win;
  } else if (handle) {
    const win = this._getWinAndPid_FromWinId(handle);

    this._win = win;
  } else {
    throw new _baseDriver.errors.UnknownError("setWindow both name and handle don't have a value");
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93aW5kb3cuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJnZXRXaW5kb3dIYW5kbGUiLCJfd2luIiwid2lkIiwiZ2V0V2luZG93SGFuZGxlcyIsImFwcE5hbWUiLCJwaWRzIiwiYXBpcyIsImFwcF9ydW5uaW5nIiwibGVuZ3RoIiwiZXJyb3JzIiwiTm9TdWNoV2luZG93RXJyb3IiLCJ3aW5IaWVyYWNoeSIsImFwcF9nZXRXaW5kb3dIaWVyYWNoeSIsImRvYyIsImRvbSIsInBhcnNlRnJvbVN0cmluZyIsInhwYXRoIiwibWFwIiwicGlkIiwiam9pbiIsIm5vZGVzIiwid2lkcyIsIm5vZGUiLCJhdHRycyIsImF0dHJpYnV0ZXMiLCJhdHRyIiwibmFtZSIsInB1c2giLCJOdW1iZXIiLCJwYXJzZUludCIsInZhbHVlIiwiX2dldFdpbkFuZFBpZF9Gcm9tV2luTmFtZSIsIndpbmRvd05hbWUiLCJfbm9kZXMiLCJfbm9kZSIsImZpbHRlciIsInAiLCJjbGFzcyIsInNvcnQiLCJhIiwiYiIsImF2IiwiYnYiLCJfcGlkIiwiYTExeV9jaGVja1dpbmRvd0V4aXN0cyIsIl9nZXRXaW5BbmRQaWRfRnJvbVdpbklkIiwic2V0V2luZG93Iiwib3B0cyIsImhhbmRsZSIsIndpbiIsIlVua25vd25FcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsRUFBakI7O0FBRUFBLFFBQVEsQ0FBQ0MsZUFBVCxHQUEyQixlQUFlQSxlQUFmLEdBQWtDO0FBQUE7O0FBQzNELHVCQUFPLEtBQUtDLElBQVosK0NBQU8sV0FBV0MsR0FBbEI7QUFDRCxDQUZEOztBQUlBSCxRQUFRLENBQUNJLGdCQUFULEdBQTRCLGVBQWVBLGdCQUFmLEdBQW1DO0FBQzdELFFBQU1DLE9BQU8sR0FBRyxLQUFLQSxPQUFyQjs7QUFDQSxRQUFNQyxJQUFJLEdBQUdDLHFCQUFLQyxXQUFMLENBQWlC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aEIsSUFBQUEsR0FBRyxFQUFFMEIsTUFBTSxDQUFDQyxRQUFQLENBQWdCUCxJQUFJLENBQUNwQixHQUFyQixDQUZBO0FBR0x3QixJQUFBQSxJQUFJLEVBQUVKLElBQUksQ0FBQ0k7QUFITixHQUFQO0FBS0QsQ0FwQkQ7O0FBc0JBM0IsUUFBUSxDQUFDK0MsU0FBVCxHQUFxQixTQUFTQSxTQUFULENBQW9CQyxJQUFJLEdBQUcsRUFBM0IsRUFBK0I7QUFDbEQsUUFBTTtBQUFDckIsSUFBQUEsSUFBRDtBQUFPc0IsSUFBQUE7QUFBUCxNQUFpQkQsSUFBdkI7O0FBQ0EsTUFBSXJCLElBQUosRUFBVTtBQUNSLFVBQU11QixHQUFHLEdBQUcsS0FBS2xCLHlCQUFMLENBQStCTCxJQUEvQixDQUFaOztBQUNBLFNBQUt6QixJQUFMLEdBQVlnRCxHQUFaO0FBQ0QsR0FIRCxNQUdPLElBQUlELE1BQUosRUFBWTtBQUNqQixVQUFNQyxHQUFHLEdBQUcsS0FBS0osdUJBQUwsQ0FBNkJHLE1BQTdCLENBQVo7O0FBQ0EsU0FBSy9DLElBQUwsR0FBWWdELEdBQVo7QUFDRCxHQUhNLE1BR0E7QUFDTCxVQUFNLElBQUl4QyxtQkFBT3lDLFlBQVgsQ0FBd0IsbURBQXhCLENBQU47QUFDRDtBQUNGLENBWEQ7O2VBYWVuRCxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFwaXMgZnJvbSAnQHN0ZHNwYS9zdGRzcGFsaW51eF90ZW1wL2Rpc3QvcHJpdmF0ZWFwaXMnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHNlbGVjdCBmcm9tICd4cGF0aC5qcyc7XG5pbXBvcnQgeyBET01QYXJzZXIgYXMgZG9tIH0gZnJvbSAneG1sZG9tJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ0BhcHBpdW0vYmFzZS1kcml2ZXInO1xuXG5jb25zdCBjb21tYW5kcyA9IHt9O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGUgPSBhc3luYyBmdW5jdGlvbiBnZXRXaW5kb3dIYW5kbGUgKCkge1xuICByZXR1cm4gdGhpcy5fd2luPy53aWQ7XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dIYW5kbGVzID0gYXN5bmMgZnVuY3Rpb24gZ2V0V2luZG93SGFuZGxlcyAoKSB7XG4gIGNvbnN0IGFwcE5hbWUgPSB0aGlzLmFwcE5hbWU7XG4gIGNvbnN0IHBpZHMgPSBhcGlzLmFwcF9ydW5uaW5nKGFwcE5hbWUpO1xuICBpZiAoIXBpZHMgfHwgcGlkcy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGBhcHBsaWNhdGlvbiAke2FwcE5hbWV9IGlzIG5vdCBydW5uaW5nYCk7XG4gIH1cbiAgY29uc3Qgd2luSGllcmFjaHkgPSBhcGlzLmFwcF9nZXRXaW5kb3dIaWVyYWNoeSgpO1xuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHdpbkhpZXJhY2h5KTtcbiAgbGV0IHhwYXRoID0gcGlkcy5tYXAocGlkID0+IGBAcGlkPVwiJHtwaWR9XCJgKS5qb2luKFwiIG9yIFwiKTtcbiAgeHBhdGggPSBgLy8qWyR7eHBhdGh9XWA7XG4gIGNvbnN0IG5vZGVzID0gc2VsZWN0KGRvYywgeHBhdGgpO1xuICBpZiAoIW5vZGVzIHx8IG5vZGVzLmxlbmd0aCA9PSAwKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIGNvbnN0IHdpZHMgPSBbXTtcbiAgZm9yIChjb25zdCBub2RlIG9mIG5vZGVzKSB7XG4gICAgY29uc3QgYXR0cnMgPSBub2RlLmF0dHJpYnV0ZXM7XG4gICAgZm9yIChjb25zdCBhdHRyIG9mIGF0dHJzKSB7XG4gICAgICBpZiAoYXR0ci5uYW1lID09IFwid2lkXCIpIHtcbiAgICAgICAgd2lkcy5wdXNoKE51bWJlci5wYXJzZUludChhdHRyLnZhbHVlKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB3aWRzO1xufVxuXG5jb21tYW5kcy5fZ2V0V2luQW5kUGlkX0Zyb21XaW5OYW1lID0gZnVuY3Rpb24gKHdpbmRvd05hbWUpIHtcbiAgY29uc3QgcGlkcyA9IGFwaXMuYXBwX3J1bm5pbmcoYXBwTmFtZSk7XG4gIGlmICghcGlkcyB8fCBwaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYGFwcGxpY2F0aW9uICR7dGhpcy5hcHBOYW1lfSBpcyBub3QgcnVubmluZ2ApO1xuICB9XG4gIGNvbnN0IHdpbkhpZXJhY2h5ID0gYXBpcy5hcHBfZ2V0V2luZG93SGllcmFjaHkoKTtcbiAgY29uc3QgZG9jID0gbmV3IGRvbSgpLnBhcnNlRnJvbVN0cmluZyh3aW5IaWVyYWNoeSk7XG4gIGxldCB4cGF0aCA9IHBpZHMubWFwKHBpZCA9PiBgQHBpZD1cIiR7cGlkfVwiYCkuam9pbihcIiBvciBcIik7XG4gIHhwYXRoID0gYC8vKlsoJHt4cGF0aH0pIGFuZCAoQG5hbWU9XCIke3dpbmRvd05hbWV9XCIgb3IgY29udGFpbnMoY29uY2F0KFwiIFwiLCBAY2xhc3MsIFwiIFwiKSwgXCIke1wiIFwiICsgd2luZG93TmFtZSArIFwiIFwifVwiKSldYDtcbiAgY29uc3Qgbm9kZXMgPSBzZWxlY3QoZG9jLCB4cGF0aCk7XG4gIGlmICghbm9kZXMgfHwgbm9kZXMubGVuZ3RoID09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93ICR7d2luZG93TmFtZX0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgbGV0IF9ub2RlcyA9IFtdO1xuICBmb3IgKGNvbnN0IG5vZGUgb2Ygbm9kZXMpIHtcbiAgICBjb25zdCBhdHRycyA9IG5vZGUuYXR0cmlidXRlcztcbiAgICBjb25zdCBfbm9kZSA9IHt9O1xuICAgIGZvciAoY29uc3QgYXR0ciBvZiBhdHRycykge1xuICAgICAgX25vZGVbYXR0ci5uYW1lXSA9IGF0dHIudmFsdWU7XG4gICAgfVxuICAgIF9ub2Rlcy5wdXNoKF9ub2RlKTtcbiAgfVxuICBfbm9kZXMgPSBfbm9kZXMuZmlsdGVyKHAgPT4gKHAubmFtZSB8fCBwLmNsYXNzKSAmJiBwLnBpZCAmJiBwLndpZCk7XG4gIGlmIChfbm9kZXMubGVuZ3RoID09IDApIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93ICR7d2luZG93TmFtZX0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgX25vZGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICBjb25zdCBhdiA9IGEubmFtZSA9PSB3aW5kb3dOYW1lPyAtMTogMTtcbiAgICBjb25zdCBidiA9IGIubmFtZSA9PSB3aW5kb3dOYW1lPyAtMTogMTtcbiAgICByZXR1cm4gYXYgLSBidjtcbiAgfSk7XG4gIGZvciAoY29uc3QgX25vZGUgb2YgX25vZGVzKSB7XG4gICAgY29uc3QgX3BpZCA9IE51bWJlci5wYXJzZUludChfbm9kZS5waWQpO1xuICAgIGlmIChhcGlzLmExMXlfY2hlY2tXaW5kb3dFeGlzdHMod2luZG93TmFtZSwgX3BpZCkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHBpZDogX3BpZCxcbiAgICAgICAgd2lkOiBOdW1iZXIucGFyc2VJbnQoX25vZGUud2lkKSxcbiAgICAgICAgbmFtZTogd2luZG93TmFtZVxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcihgdGhlIHdpbmRvdyAke3dpbmRvd05hbWV9IGRvZXNuJ3QgcHJlc2VudGApO1xufVxuXG5jb21tYW5kcy5fZ2V0V2luQW5kUGlkX0Zyb21XaW5JZCA9IGZ1bmN0aW9uICh3aWQpIHtcbiAgY29uc3Qgd2luSGllcmFjaHkgPSBhcGlzLmFwcF9nZXRXaW5kb3dIaWVyYWNoeSgpO1xuICBjb25zdCBkb2MgPSBuZXcgZG9tKCkucGFyc2VGcm9tU3RyaW5nKHdpbkhpZXJhY2h5KTtcbiAgY29uc3QgeHBhdGggPSBgLy8qW0B3aWQ9XCIke3dpZH1cIl1gO1xuICBjb25zdCBub2RlcyA9IHNlbGVjdChkb2MsIHhwYXRoKTtcbiAgaWYgKCFub2RlcyB8fCBub2Rlcy5sZW5ndGggPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgd2lkPSR7d2lkfSBkb2Vzbid0IHByZXNlbnRgKTtcbiAgfVxuICBjb25zdCBub2RlID0gbm9kZXNbMF07XG4gIGlmICghbm9kZS5uYW1lIHx8ICFub2RlLnBpZCB8fCAhbm9kZS53aWQpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKGB0aGUgd2luZG93IHdpZD0ke3dpZH0gZG9lc24ndCBwcmVzZW50YCk7XG4gIH1cbiAgaWYgKCFhcGlzLmExMXlfY2hlY2tXaW5kb3dFeGlzdHMobm9kZS5uYW1lLCBOdW1iZXIucGFyc2VJbnQobm9kZS5waWQpKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoV2luZG93RXJyb3IoYHRoZSB3aW5kb3cgd2lkPSR7d2lkfSBkb2Vzbid0IHByZXNlbnRgKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIHBpZDogTnVtYmVyLnBhcnNlSW50KG5vZGUucGlkKSxcbiAgICB3aWQ6IE51bWJlci5wYXJzZUludChub2RlLndpZCksXG4gICAgbmFtZTogbm9kZS5uYW1lXG4gIH07XG59XG5cbmNvbW1hbmRzLnNldFdpbmRvdyA9IGZ1bmN0aW9uIHNldFdpbmRvdyAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtuYW1lLCBoYW5kbGV9ID0gb3B0cztcbiAgaWYgKG5hbWUpIHtcbiAgICBjb25zdCB3aW4gPSB0aGlzLl9nZXRXaW5BbmRQaWRfRnJvbVdpbk5hbWUobmFtZSk7XG4gICAgdGhpcy5fd2luID0gd2luO1xuICB9IGVsc2UgaWYgKGhhbmRsZSkge1xuICAgIGNvbnN0IHdpbiA9IHRoaXMuX2dldFdpbkFuZFBpZF9Gcm9tV2luSWQoaGFuZGxlKTtcbiAgICB0aGlzLl93aW4gPSB3aW47XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoXCJzZXRXaW5kb3cgYm90aCBuYW1lIGFuZCBoYW5kbGUgZG9uJ3QgaGF2ZSBhIHZhbHVlXCIpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzOyJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3dpbmRvdy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
